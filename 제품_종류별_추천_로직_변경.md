# 제품 종류별 추천 로직 변경

## 📋 변경 요구사항

**기존**: 카테고리별 상위 3개 추천
**변경**: 제품 종류별 상위 3개 추천

### 제품 종류 예시
- 세탁기 3개
- 청소기 3개
- 워시타워 3개
- 워시콤보 3개
- 에어컨 3개
- 제습기 3개
- 공기청정기 3개
- 안마의자 3개
- 냉장고 3개
- TV 3개
- 등등...

### 핵심 요구사항
- 시나리오별로 제품 종류별 점수 산정 방식이 달라야 함

---

## ✅ 구현 내용

### 1. 제품 종류 분류 유틸리티 (`api/utils/product_type_classifier.py`)

#### 주요 함수

1. **`extract_product_type(product)`**
   - 제품명에서 제품 종류 추출
   - 키워드 매칭 기반 분류
   - 예: "LG 트롬 세탁기" → "세탁기"

2. **`get_product_types_for_scenario(user_profile, onboarding_data)`**
   - 시나리오별 추천할 제품 종류 목록 결정
   - 가구 구성, 생활 패턴에 따라 동적으로 결정
   - 예: 4인 가족 → 냉장고, 워시타워, 청소기, TV, 에어컨 등

3. **`group_products_by_type(products)`**
   - 제품 리스트를 제품 종류별로 그룹화
   - 반환: `{'세탁기': [product1, product2], '청소기': [product3], ...}`

#### 제품 종류 키워드 매핑

```python
PRODUCT_TYPE_KEYWORDS = {
    '세탁기': ['세탁기', '트롬', '워시', 'WASH', '통돌이'],
    '건조기': ['건조기', 'DRY', '드라이', '건조'],
    '워시타워': ['워시타워', '워시타', 'WASHTOWER', '세탁+건조'],
    '청소기': ['청소기', '코드제로', 'CODEZERO', '로봇청소기', ...],
    '냉장고': ['냉장고', '디오스', 'DIOS', '컨버터블', ...],
    'TV': ['TV', '티비', '올레드', 'OLED', 'QNED', ...],
    '에어컨': ['에어컨', 'AIR', '인버터', ...],
    # ... 등등
}
```

---

### 2. 추천 엔진 수정 (`api/services/recommendation_engine.py`)

#### 변경된 로직

**이전:**
```python
# 카테고리별로 그룹화
for category in categories:
    category_products = filtered_products.filter(category=category)
    # 각 카테고리에서 상위 3개 선택
```

**변경 후:**
```python
# 제품 종류별로 그룹화
products_by_type = group_products_by_type(products_list)
target_product_types = get_product_types_for_scenario(user_profile, onboarding_data)

for product_type in target_product_types:
    type_products = products_by_type[product_type]
    # 각 제품 종류별로 상위 3개 선택
    scored_products = self._score_products_by_type(
        type_products,
        user_profile,
        product_type,  # 제품 종류별 점수 산정
        taste_id
    )
```

#### 새로운 메서드

1. **`_score_products_by_type(products, user_profile, product_type, taste_id)`**
   - 제품 종류별 스코어링
   - 시나리오별 점수 산정 방식 차등화
   - 제품 종류별 가중치 배율 적용

2. **`_get_product_type_multiplier(product_type, user_profile, onboarding_data)`**
   - 제품 종류별 가중치 배율 반환
   - 시나리오별 차등화된 점수 산정

---

## 🎯 시나리오별 제품 종류별 점수 산정 예시

### 예시 1: 4인 가족 + 세탁기
```python
if product_type == '세탁기':
    if laundry == 'daily' and household_size >= 3:
        multiplier = 1.2  # 세탁 빈도 높고 가족이 많으면 높은 가중치
```

### 예시 2: 1인 가구 + 워시타워
```python
if product_type == '워시타워':
    if household_size == 1:
        multiplier = 0.7  # 1인 가구는 낮은 가중치
```

### 예시 3: 요리 많이 하는 가족 + 식기세척기
```python
if product_type == '식기세척기':
    if cooking == 'high' and household_size >= 3:
        multiplier = 1.3  # 요리 많이 하는 가족에게 높은 가중치
```

### 예시 4: 게이머 + TV
```python
if product_type == 'TV':
    if media == 'gaming':
        multiplier = 1.3  # 게이머에게 높은 가중치
```

---

## 📊 추천 결과 구조

### 입력
```json
{
  "household_size": 4,
  "housing_type": "apartment",
  "onboarding_data": {
    "cooking": "high",
    "laundry": "daily",
    "media": "gaming"
  }
}
```

### 출력
```json
{
  "success": true,
  "count": 15,  // 총 15개 (5개 제품 종류 × 3개씩)
  "recommendations": [
    // 세탁기 3개
    {"product_type": "세탁기", "name": "LG 트롬 세탁기", ...},
    {"product_type": "세탁기", "name": "LG 워시타워", ...},
    {"product_type": "세탁기", "name": "LG 세탁기", ...},
    
    // 청소기 3개
    {"product_type": "청소기", "name": "LG 코드제로 A9", ...},
    {"product_type": "청소기", "name": "LG 로봇청소기", ...},
    {"product_type": "청소기", "name": "LG 청소기", ...},
    
    // 냉장고 3개
    {"product_type": "냉장고", "name": "LG 디오스 냉장고", ...},
    // ...
    
    // TV 3개
    // 에어컨 3개
    // ...
  ]
}
```

---

## 🔄 추천 로직 플로우

```
1. 전체 제품 필터링
   ↓
2. 제품 종류별로 그룹화
   ├─ 세탁기 그룹
   ├─ 청소기 그룹
   ├─ 냉장고 그룹
   └─ ...
   ↓
3. 시나리오별 추천할 제품 종류 목록 결정
   ├─ 4인 가족 → [세탁기, 청소기, 냉장고, TV, 에어컨]
   ├─ 1인 가구 → [세탁기, 청소기, 냉장고, TV]
   └─ ...
   ↓
4. 각 제품 종류별로:
   ├─ 시나리오별 점수 산정 (차등화)
   ├─ 상위 3개 선택
   └─ 포맷팅
   ↓
5. 모든 제품 종류의 추천 합치기
   ↓
6. 최종 추천 결과 반환
```

---

## ⚠️ 주의사항

1. **제품 종류 추출 정확도**: 제품명에서 키워드 매칭으로 추출하므로, 제품명이 비표준이면 잘못 분류될 수 있음

2. **시나리오별 제품 종류 목록**: `get_product_types_for_scenario()` 함수에서 동적으로 결정되며, 필요시 수정 필요

3. **점수 산정 방식 차등화**: `_get_product_type_multiplier()` 함수에서 제품 종류별로 다른 가중치 적용

4. **제품 종류별 최소 1개**: 각 제품 종류에서 추천 제품이 없는 경우 해당 종류는 결과에 포함되지 않음

---

## ✅ 구현 완료 항목

- [x] 제품 종류 분류 유틸리티 생성
- [x] 시나리오별 추천할 제품 종류 목록 결정 로직
- [x] 제품 종류별 그룹화 로직
- [x] 제품 종류별 스코어링 메서드 추가
- [x] 시나리오별 제품 종류별 점수 산정 방식 차등화
- [x] 추천 엔진 메인 로직 수정

---

## 🔜 추가 작업 필요

- [ ] Playbook 추천 엔진도 동일하게 변경
- [ ] 제품 종류 추출 정확도 향상 (더 많은 키워드 추가)
- [ ] 시나리오별 제품 종류 목록 정책 테이블화


