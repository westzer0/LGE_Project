Step 5: 추천 결과 포맷팅 및 반환 검증 - 최종 추천 결과를 적절한 형식으로 포맷팅하고 반환하는 로직 검증


현재 상황:

- Step 1 완료: 추천 엔진 인프라 확인 완료
- Step 2 완료: Taste 기반 카테고리 선택 로직 검증 완료
- Step 3 완료: 카테고리별 제품 조회 로직 검증 완료
- Step 4 완료: 예산/조건 기반 제품 필터링 검증 완료
- 추천 결과를 API 응답 형식으로 포맷팅하고 반환하는 로직 필요


목표:

필터링된 제품을 추천 결과 형식으로 포맷팅하고 반환하는 로직이 올바르게 작동하는지 검증
- 추천 결과 데이터 구조 검증
- 카테고리별 제품 그룹화 검증
- 상위 제품 선택 및 정렬 검증
- API 응답 형식 검증


검증 항목:

1. 추천 결과 데이터 구조 검증
   - 추천 결과가 올바른 형식인지 확인
   - 필수 필드 존재 여부 확인
   - 제품 정보의 완전성 확인

2. 카테고리별 제품 그룹화 검증
   - 제품이 카테고리별로 그룹화되는지 확인
   - 각 카테고리별 상위 제품 수 확인
   - 카테고리별 제품 정렬 확인

3. 상위 제품 선택 검증
   - 각 카테고리에서 상위 N개 제품만 선택하는지 확인
   - 제품 선택 기준 확인 (인기순, 가격순, 추천 점수 등)
   - 선택된 제품이 적절한지 확인

4. 추천 결과 정렬 검증
   - 카테고리별 정렬 순서 확인
   - 카테고리 내 제품 정렬 순서 확인
   - 전체 추천 결과의 우선순위 확인

5. API 응답 형식 검증
   - API 응답이 올바른 JSON 형식인지 확인
   - 응답 스키마 검증
   - 에러 응답 형식 확인

6. 실제 데이터로 검증
   - 실제 회원의 Taste ID와 온보딩 데이터로 전체 플로우 실행
   - 최종 추천 결과 검증
   - 결과가 사용자에게 유용한지 확인


관련 파일 (예상):

- api/services/recommendation_service.py
  - get_recommendations() 메서드 (예상)
  - 회원 ID 또는 Taste ID를 입력받아 추천 결과 반환
  - format_recommendation_results() 메서드 (예상)

- api/views.py
  - recommendation_view() 함수 (예상)
  - 추천 API 엔드포인트

- api/serializers.py (존재 여부 확인 필요)
  - 추천 결과 시리얼라이저


작업:

1. 추천 결과 포맷팅 로직 찾기:
   - 코드베이스에서 추천 결과 포맷팅 로직 검색
   - 추천 결과 반환 함수/메서드 확인

2. 데이터 구조 검증:
   - 추천 결과 스키마 확인
   - 필수 필드 존재 여부 확인
   - 제품 정보 완전성 확인

3. 카테고리별 그룹화 검증:
   - 제품이 카테고리별로 그룹화되는지 확인
   - 각 카테고리별 제품 수 확인

4. 상위 제품 선택 검증:
   - 각 카테고리에서 상위 N개 제품 선택 확인
   - 선택 기준 확인

5. API 응답 검증:
   - API 엔드포인트 테스트
   - 응답 형식 검증
   - 에러 처리 확인

6. 실제 데이터로 검증:
   - 실제 회원 데이터로 전체 플로우 실행
   - 최종 결과 검증

7. 시각화 생성:
   - 추천 결과 구조 다이어그램
   - 카테고리별 제품 수 분포
   - 추천 결과 샘플


검증 방법:

1. 추천 결과 구조 테스트:
   ```python
   # 회원 ID로 추천 결과 조회
   member_id = 'user_123'
   recommendations = get_recommendations(member_id)
   
   # 추천 결과 구조 확인
   assert 'categories' in recommendations or 'products' in recommendations
   assert 'member_id' in recommendations or 'taste_id' in recommendations
   
   # 카테고리별 제품 확인
   if 'categories' in recommendations:
       for category in recommendations['categories']:
           assert 'category_id' in category
           assert 'category_name' in category
           assert 'products' in category
           assert isinstance(category['products'], list)
   ```

2. 카테고리별 그룹화 테스트:
   ```python
   recommendations = get_recommendations(member_id)
   
   # 카테고리별 제품 수 확인
   category_product_counts = {}
   for category in recommendations['categories']:
       category_id = category['category_id']
       product_count = len(category['products'])
       category_product_counts[category_id] = product_count
       # 각 카테고리별 최대 제품 수 확인 (예: 상위 10개)
       assert product_count <= 10
   ```

3. 상위 제품 선택 테스트:
   ```python
   # 각 카테고리의 제품이 정렬되어 있는지 확인
   for category in recommendations['categories']:
       products = category['products']
       if len(products) > 1:
           # 정렬 기준 확인 (예: 추천 점수 내림차순)
           scores = [p.get('recommendation_score', 0) for p in products]
           assert scores == sorted(scores, reverse=True)
   ```

4. API 응답 테스트:
   ```python
   # API 엔드포인트 호출
   response = client.get(f'/api/recommendations/{member_id}')
   
   # 응답 상태 코드 확인
   assert response.status_code == 200
   
   # JSON 형식 확인
   data = response.json()
   assert isinstance(data, dict)
   
   # 응답 스키마 확인
   assert 'categories' in data or 'products' in data
   ```

5. 실제 데이터 테스트:
   ```python
   # 실제 회원 데이터로 전체 플로우 실행
   members = get_members_with_taste(limit=50)
   
   for member in members:
       member_id = member['member_id']
       
       # 추천 결과 조회
       recommendations = get_recommendations(member_id)
       
       # 결과 검증
       assert 'categories' in recommendations or 'products' in recommendations
       
       # 카테고리별 제품 존재 확인
       if 'categories' in recommendations:
           total_products = sum(len(c['products']) for c in recommendations['categories'])
           assert total_products > 0  # 최소 1개 이상의 제품 추천
   ```


예상 결과 형식:

```json
{
  "member_id": "user_123",
  "taste_id": 50,
  "recommendations": {
    "categories": [
      {
        "category_id": 1,
        "category_name": "가전제품",
        "products": [
          {
            "product_id": 101,
            "name": "제품명",
            "price": 500000,
            "image_url": "https://...",
            "recommendation_score": 0.95,
            "reason": "예산 범위 내, 요리 빈도 높음"
          },
          ...
        ]
      },
      ...
    ],
    "total_products": 25,
    "generated_at": "2025-01-10T12:00:00Z"
  }
}
```


예상 결과:

1. 추천 결과 구조:
   - 올바른 JSON 형식
   - 필수 필드 모두 존재
   - 제품 정보 완전함

2. 카테고리별 그룹화:
   - 제품이 카테고리별로 그룹화됨
   - 각 카테고리별 상위 제품 선택됨
   - 카테고리별 제품 수 적절함 (예: 5-10개)

3. 상위 제품 선택:
   - 각 카테고리에서 상위 N개 제품만 선택됨
   - 선택 기준에 따라 정렬됨

4. API 응답:
   - 올바른 HTTP 상태 코드
   - 올바른 JSON 형식
   - 에러 시 적절한 에러 응답

5. 실제 데이터:
   - 대부분의 회원에 대해 추천 결과 생성 성공
   - 추천된 제품이 사용자에게 유용함


테스트 스크립트 구조:

```python
class RecommendationFormattingValidator:
    """추천 결과 포맷팅 및 반환 검증 클래스"""
    
    def validate_all(self):
        """모든 검증 실행"""
        # 1. 추천 결과 데이터 구조 검증
        # 2. 카테고리별 제품 그룹화 검증
        # 3. 상위 제품 선택 검증
        # 4. 추천 결과 정렬 검증
        # 5. API 응답 형식 검증
        # 6. 실제 데이터로 검증
    
    def _validate_result_structure(self):
        """추천 결과 데이터 구조 검증"""
    
    def _validate_category_grouping(self):
        """카테고리별 제품 그룹화 검증"""
    
    def _validate_top_products_selection(self):
        """상위 제품 선택 검증"""
    
    def _validate_sorting(self):
        """추천 결과 정렬 검증"""
    
    def _validate_api_response(self):
        """API 응답 형식 검증"""
    
    def _validate_with_real_data(self):
        """실제 데이터로 검증"""
        # 실제 회원 데이터로 전체 플로우 실행
```


시각화 항목:

1. 추천 결과 구조 다이어그램
2. 카테고리별 제품 수 분포 바 차트
3. 추천 결과 샘플 (JSON 형식)
4. API 응답 성공/실패 비율
5. 카테고리별 평균 제품 수


참고:

- Step 2, 3, 4에서 검증한 모든 로직의 최종 결과물
- API 응답 형식은 프론트엔드 요구사항과 일치해야 함
- 추천 결과가 사용자에게 유용하고 이해하기 쉬워야 함
- 에러 발생 시 적절한 에러 메시지 반환 필요

