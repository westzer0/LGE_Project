Step 4: 포트폴리오 생성 API 구현 및 통합 - 추천 결과로부터 포트폴리오 자동 생성 API 구현

현재 상황:

- Step 1 완료: 포트폴리오 인프라 확인 완료
- Step 2 완료: 추천 결과를 포트폴리오로 변환하는 로직 구현 완료
- Step 3 완료: PORTFOLIO/PORTFOLIO_PRODUCT/PORTFOLIO_SESSION 저장 로직 구현 완료
- 온보딩 완료 시점: 온보딩 완료 시 포트폴리오 자동 생성 필요


목표:

추천 결과로부터 포트폴리오를 자동 생성하는 API 구현 및 통합
- 온보딩 완료 시 포트폴리오 자동 생성
- 추천 결과 조회 → 포트폴리오 변환 → 저장 전체 플로우 통합
- API 엔드포인트 구현
- 에러 처리 및 로깅
- Django DB와 Oracle DB 동시 저장


검증 항목:

1. 포트폴리오 생성 API 엔드포인트
   - POST /api/portfolio/create/ 또는 /api/portfolio/save/ 엔드포인트 확인
   - 요청 파라미터 검증 (session_id, user_id 등)
   - 응답 형식 확인 (portfolio_id, style_analysis, total_price 등)
   - 에러 응답 처리

2. 온보딩 완료 시 포트폴리오 자동 생성
   - onboarding_complete_view()에서 포트폴리오 생성 호출 확인
   - 온보딩 완료 시 자동으로 포트폴리오 생성되는지 확인
   - 세션 ID와 사용자 ID 전달 확인

3. 전체 플로우 통합
   - 추천 결과 조회 → 포트폴리오 변환 → 저장 전체 플로우 확인
   - 각 단계별 에러 처리 확인
   - 부분 실패 시 롤백 처리 확인

4. Django DB와 Oracle DB 동시 저장
   - Django DB (Portfolio 모델) 저장 확인
   - Oracle DB (PORTFOLIO/PORTFOLIO_PRODUCT/PORTFOLIO_SESSION) 저장 확인
   - 두 DB 모두 저장 성공해야 완료로 간주

5. 에러 처리
   - 추천 결과가 없는 경우 처리
   - 세션을 찾을 수 없는 경우 처리
   - 저장 실패 시 에러 처리
   - 사용자에게 적절한 에러 메시지 반환

6. 로깅
   - 포트폴리오 생성 시작/완료 로깅
   - 각 단계별 로깅
   - 에러 발생 시 상세 로깅


관련 파일:

- api/views.py
  - onboarding_complete_view() 함수
  - portfolio_save_view() 함수
  - 포트폴리오 생성 API 엔드포인트

- api/services/portfolio_service.py
  - create_portfolio_from_onboarding() 함수
  - 추천 결과 조회 및 변환 로직
  - Django DB 및 Oracle DB 저장 로직

- api/services/recommendation_service.py
  - get_recommendations() 함수
  - 추천 결과 조회

- api/models.py
  - Portfolio 모델
  - OnboardingSession 모델


작업:

1. 포트폴리오 생성 API 엔드포인트 확인/구현:
   - portfolio_save_view() 함수 확인
   - 요청 파라미터 검증 추가
   - 응답 형식 확인 및 개선

2. 온보딩 완료 시 포트폴리오 자동 생성 통합:
   - onboarding_complete_view()에서 포트폴리오 생성 호출 확인
   - 세션 완료 후 포트폴리오 생성 로직 추가
   - 에러 발생 시에도 온보딩 완료는 성공으로 처리

3. 전체 플로우 통합:
   - create_portfolio_from_onboarding() 함수에서 전체 플로우 통합
   - 추천 결과 조회 → 변환 → 저장 순서 확인
   - 각 단계별 에러 처리 추가

4. Django DB와 Oracle DB 동시 저장:
   - Django DB 저장 후 Oracle DB 저장
   - Oracle DB 저장 실패 시에도 Django DB 저장은 유지 (하위 호환성)
   - 두 DB 모두 저장 성공 시에만 완료로 간주

5. 에러 처리 개선:
   - 추천 결과가 없는 경우 처리
   - 세션을 찾을 수 없는 경우 처리
   - 저장 실패 시 에러 처리
   - 사용자에게 적절한 에러 메시지 반환

6. 로깅 추가:
   - 포트폴리오 생성 시작/완료 로깅
   - 각 단계별 상세 로깅
   - 에러 발생 시 상세 로깅


검증 방법:

1. 포트폴리오 생성 API 테스트:
   ```python
   def test_portfolio_create_api():
       """포트폴리오 생성 API 테스트"""
       session_id = "test_session_123"
       user_id = "user_123"
       
       # API 요청
       response = client.post('/api/portfolio/save/', {
           'session_id': session_id,
           'user_id': user_id
       })
       
       assert response.status_code == 200
       data = response.json()
       assert data['success'] == True
       assert 'portfolio_id' in data
       assert 'style_analysis' in data
       assert 'total_price' in data
       
       print(f"✅ 포트폴리오 생성 성공: {data['portfolio_id']}")
   ```

2. 온보딩 완료 시 포트폴리오 자동 생성 테스트:
   ```python
   def test_onboarding_complete_auto_portfolio():
       """온보딩 완료 시 포트폴리오 자동 생성 테스트"""
       session_id = "test_session_123"
       
       # 온보딩 완료 API 요청
       response = client.post('/api/onboarding/complete/', {
           'session_id': session_id,
           # ... 온보딩 데이터 ...
       })
       
       assert response.status_code == 200
       data = response.json()
       
       # 포트폴리오가 자동 생성되었는지 확인
       if 'portfolio_id' in data:
           print(f"✅ 포트폴리오 자동 생성 성공: {data['portfolio_id']}")
           
           # 포트폴리오 조회 확인
           portfolio = Portfolio.objects.get(portfolio_id=data['portfolio_id'])
           assert portfolio is not None
           assert portfolio.onboarding_session.session_id == session_id
       else:
           print("⚠️ 포트폴리오 자동 생성되지 않음 (에러 로그 확인 필요)")
   ```

3. 전체 플로우 통합 테스트:
   ```python
   def test_portfolio_creation_full_flow():
       """포트폴리오 생성 전체 플로우 테스트"""
       session_id = "test_session_123"
       user_id = "user_123"
       
       # 1. 추천 결과 확인
       recommendations = get_recommendations_for_session(session_id)
       assert recommendations is not None
       print(f"✅ Step 1: 추천 결과 조회 성공 ({len(recommendations.get('categories', []))}개 카테고리)")
       
       # 2. 포트폴리오 생성
       result = portfolio_service.create_portfolio_from_onboarding(
           session_id=session_id,
           user_id=user_id
       )
       
       assert result['success'] == True
       portfolio_id = result['portfolio_id']
       print(f"✅ Step 2: 포트폴리오 생성 성공 ({portfolio_id})")
       
       # 3. Django DB 저장 확인
       portfolio = Portfolio.objects.get(portfolio_id=portfolio_id)
       assert portfolio is not None
       assert len(portfolio.products) > 0
       print(f"✅ Step 3: Django DB 저장 확인 ({len(portfolio.products)}개 제품)")
       
       # 4. Oracle DB 저장 확인
       oracle_portfolio = get_portfolio_from_oracle(portfolio_id)
       assert oracle_portfolio is not None
       print(f"✅ Step 4: Oracle DB 저장 확인")
       
       # 5. 데이터 일치 확인
       assert len(portfolio.products) == len(oracle_portfolio['products'])
       print(f"✅ Step 5: 데이터 일치 확인")
   ```

4. 에러 처리 테스트:
   ```python
   def test_portfolio_creation_errors():
       """포트폴리오 생성 에러 처리 테스트"""
       # 1. 존재하지 않는 세션
       result = portfolio_service.create_portfolio_from_onboarding(
           session_id="invalid_session",
           user_id="user_123"
       )
       assert result['success'] == False
       assert 'error' in result
       print("✅ 존재하지 않는 세션 에러 처리 확인")
       
       # 2. 추천 결과가 없는 경우
       # (추천 결과가 없는 세션으로 테스트)
       # ...
   ```

5. 동시 저장 테스트:
   ```python
   def test_dual_db_storage():
       """Django DB와 Oracle DB 동시 저장 테스트"""
       session_id = "test_session_123"
       user_id = "user_123"
       
       result = portfolio_service.create_portfolio_from_onboarding(
           session_id=session_id,
           user_id=user_id
       )
       
       assert result['success'] == True
       portfolio_id = result['portfolio_id']
       
       # Django DB 확인
       django_portfolio = Portfolio.objects.get(portfolio_id=portfolio_id)
       assert django_portfolio is not None
       
       # Oracle DB 확인
       oracle_portfolio = get_portfolio_from_oracle(portfolio_id)
       assert oracle_portfolio is not None
       
       # 데이터 일치 확인
       assert django_portfolio.portfolio_id == oracle_portfolio['portfolio_id']
       assert len(django_portfolio.products) == len(oracle_portfolio['products'])
       
       print("✅ Django DB와 Oracle DB 동시 저장 확인")
   ```


예상 결과:

1. 포트폴리오 생성 API:
   - API 엔드포인트 정상 작동
   - 요청 파라미터 검증 정상
   - 응답 형식 정상
   - 에러 응답 처리 정상

2. 온보딩 완료 시 포트폴리오 자동 생성:
   - 온보딩 완료 시 자동으로 포트폴리오 생성
   - 포트폴리오 ID가 응답에 포함
   - 에러 발생 시에도 온보딩 완료는 성공

3. 전체 플로우 통합:
   - 추천 결과 조회 → 변환 → 저장 전체 플로우 정상 작동
   - 각 단계별 에러 처리 정상
   - 부분 실패 시 롤백 정상 작동

4. Django DB와 Oracle DB 동시 저장:
   - 두 DB 모두 저장 성공
   - 데이터 일치 확인
   - Oracle DB 저장 실패 시에도 Django DB 저장은 유지

5. 에러 처리:
   - 모든 에러 케이스 적절히 처리
   - 사용자에게 적절한 에러 메시지 반환
   - 에러 로깅 정상

6. 로깅:
   - 포트폴리오 생성 시작/완료 로깅 정상
   - 각 단계별 상세 로깅 정상
   - 에러 발생 시 상세 로깅 정상


테스트 스크립트 구조:

```python
class PortfolioCreationAPIValidator:
    """포트폴리오 생성 API 검증 클래스"""
    
    def validate_all(self):
        """모든 검증 실행"""
        # 1. 포트폴리오 생성 API
        # 2. 온보딩 완료 시 포트폴리오 자동 생성
        # 3. 전체 플로우 통합
        # 4. 에러 처리
        # 5. 동시 저장
    
    def _test_portfolio_create_api(self):
        """포트폴리오 생성 API 테스트"""
    
    def _test_onboarding_complete_auto_portfolio(self):
        """온보딩 완료 시 포트폴리오 자동 생성 테스트"""
    
    def _test_portfolio_creation_full_flow(self):
        """포트폴리오 생성 전체 플로우 테스트"""
    
    def _test_portfolio_creation_errors(self):
        """포트폴리오 생성 에러 처리 테스트"""
    
    def _test_dual_db_storage(self):
        """Django DB와 Oracle DB 동시 저장 테스트"""
```


시각화 항목:

1. 포트폴리오 생성 플로우 다이어그램
2. API 요청/응답 형식
3. 포트폴리오 생성 성공/실패 비율
4. 생성 시간 분포
5. 에러 유형 분포
6. Django DB vs Oracle DB 저장 성공률


참고:

- 온보딩 완료 시 자동으로 포트폴리오가 생성되어야 함
- 포트폴리오 생성 실패 시에도 온보딩 완료는 성공으로 처리 (사용자 경험)
- Django DB와 Oracle DB 모두 저장하되, Oracle DB 저장 실패 시에도 Django DB 저장은 유지
- Step 5에서 포트폴리오 조회/관리 API를 구현할 예정
- Step 6에서 포트폴리오 공유 기능을 구현할 예정

