# 카테고리별 추천 로직 변경 사항

## 📋 변경 요구사항

**기존 로직**: 전체 제품 중 상위 N개만 추천
**변경 로직**: 각 카테고리별로 상위 3개씩 추천

### 예시
- **TV/오디오**: 상위 3개
- **주방가전**: 상위 3개  
- **생활가전**: 상위 3개
- **에어컨**: 상위 3개

---

## ✅ 변경된 파일

### 1. `api/services/recommendation_engine.py`

**변경 전:**
```python
# 전체 제품 스코어링
scored_products = self._score_products(...)

# 전체에서 상위 N개 선택
top_products = sorted(...)[:limit]
```

**변경 후:**
```python
# 카테고리별로 처리
categories = user_profile.get('categories', [])
all_recommendations = []

for category in categories:
    # 카테고리별 제품 필터링
    category_products = filtered_products.filter(category=category)
    
    # 카테고리별 스코어링
    scored_products = self._score_products(...)
    
    # 카테고리별 상위 3개 선택
    top_category_products = sorted(...)[:3]
    
    all_recommendations.extend(category_recommendations)
```

---

### 2. `api/services/playbook_recommendation_engine.py`

**변경 전:**
```python
# 전체 제품 스코어링
scored_products = self._score_products(...)

# 전체에서 상위 N개 선택
top_products = sorted(...)[:limit]
```

**변경 후:**
```python
# 카테고리별로 처리
categories = user_profile.get('categories', [])
all_recommendations = []

for category in categories:
    # 카테고리별 제품 필터링 (리스트에서)
    category_products = [p for p in filtered_products if p.category == category]
    
    # 카테고리별 스코어링
    scored_products = self._score_products(...)
    
    # 카테고리별 상위 3개 선택
    top_category_products = sorted(...)[:3]
    
    all_recommendations.extend(category_recommendations)
```

---

## 🔄 추천 로직 플로우

### 변경 전
```
1. 전체 제품 필터링
   ↓
2. 전체 제품 스코어링
   ↓
3. 전체에서 상위 N개 선택
   ↓
4. 추천 결과 반환
```

### 변경 후
```
1. 전체 제품 필터링
   ↓
2. 카테고리별로 그룹화
   ├─ TV/오디오 그룹
   ├─ 주방가전 그룹
   ├─ 생활가전 그룹
   └─ 에어컨 그룹
   ↓
3. 각 카테고리별로:
   ├─ 스코어링
   ├─ 상위 3개 선택
   └─ 포맷팅
   ↓
4. 모든 카테고리의 추천 합치기
   ↓
5. 추천 결과 반환
```

---

## 📊 추천 결과 예시

### 입력
```json
{
  "categories": ["TV", "KITCHEN", "LIVING"],
  "household_size": 4,
  "budget_level": "medium"
}
```

### 출력
```json
{
  "success": true,
  "count": 9,
  "recommendations": [
    // TV 카테고리 상위 3개
    { "category": "TV", "name": "LG OLED TV 55형", ... },
    { "category": "TV", "name": "LG QNED TV 65형", ... },
    { "category": "TV", "name": "LG 나노셀 TV 50형", ... },
    
    // KITCHEN 카테고리 상위 3개
    { "category": "KITCHEN", "name": "LG 디오스 냉장고", ... },
    { "category": "KITCHEN", "name": "LG 인덕션", ... },
    { "category": "KITCHEN", "name": "LG 식기세척기", ... },
    
    // LIVING 카테고리 상위 3개
    { "category": "LIVING", "name": "LG 워시타워", ... },
    { "category": "LIVING", "name": "LG 건조기", ... },
    { "category": "LIVING", "name": "LG 로봇청소기", ... }
  ]
}
```

---

## ⚠️ 주의사항

1. **카테고리별 최소 1개**: 각 카테고리에서 추천 제품이 없는 경우 해당 카테고리는 결과에 포함되지 않습니다.

2. **최대 3개**: 각 카테고리별로 최대 3개씩만 추천됩니다. 제품이 3개 미만인 경우 있는 만큼만 추천됩니다.

3. **전체 개수**: `count` 필드는 모든 카테고리의 추천 제품 합계입니다.
   - 예: 3개 카테고리 선택 시 최대 9개 (3개 × 3개)

4. **기존 limit 파라미터**: `limit` 파라미터는 이제 의미가 없지만 호환성을 위해 유지됩니다.

---

## 🧪 테스트 시나리오

### 시나리오 1: 1개 카테고리 선택
- **입력**: `categories: ["TV"]`
- **예상 결과**: TV 카테고리 상위 3개

### 시나리오 2: 3개 카테고리 선택
- **입력**: `categories: ["TV", "KITCHEN", "LIVING"]`
- **예상 결과**: 각 카테고리별 3개씩, 총 9개

### 시나리오 3: 카테고리별 제품 부족
- **입력**: `categories: ["TV"]` (TV 제품이 2개만 있는 경우)
- **예상 결과**: TV 2개만 추천

---

## ✅ 변경 완료

- [x] `recommendation_engine.py` 수정
- [x] `playbook_recommendation_engine.py` 수정
- [x] 카테고리별 상위 3개 로직 구현
- [x] 결과 합치기 로직 구현


