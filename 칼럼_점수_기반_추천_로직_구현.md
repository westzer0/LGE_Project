# 칼럼 점수 기반 추천 로직 구현

## 📋 요구사항

Oracle DB PRODUCT SPEC 테이블 구조:
- **SPEC_TYPE**: `COMMON` 또는 `VARIANT`
- **SPEC_KEY**: 점수 산정에 사용할 수 있는 스펙 칼럼

### 핵심 로직

1. **COMMON 칼럼**: 
   - 모든 제품 종류에 100% 공통
   - 반드시 점수 산출 로직에 포함

2. **VARIANT 칼럼**:
   - 특정 제품 종류에만 있음
   - 등장 빈도에 따라 포함/제외 결정
   - 온보딩 사용자 정보에 따라 포함/제외 로직 변경

3. **추천 프로세스**:
   - #1: 칼럼 점수 산출 결과에 따라 패키지에 포함될 가전 종류 확인
   - #2: 가전 종류별 상위 3개 모델 추천

---

## 🏗️ 구현 구조

### 1. SPEC 칼럼 점수 산출기 (`api/utils/spec_column_scorer.py`)

#### 주요 기능

1. **`analyze_spec_structure(products)`**
   - 제품 스펙 구조 분석
   - COMMON 칼럼 식별 (모든 제품 종류에 100% 존재)
   - VARIANT 칼럼 식별 (제품 종류별로 다름)
   - SPEC_KEY별 등장 빈도 계산

2. **`get_scoring_spec_keys(product_type, user_profile, onboarding_data)`**
   - 점수 산출에 사용할 SPEC_KEY 목록 반환
   - COMMON 칼럼: 반드시 포함
   - VARIANT 칼럼: 조건부 포함

3. **`calculate_product_type_column_score(...)`**
   - 제품 종류별 칼럼 점수 산출
   - COMMON 칼럼 점수 (70% 가중치)
   - VARIANT 칼럼 점수 (30% 가중치)

#### COMMON 칼럼 식별 로직

```python
# 모든 제품 종류에서 100% 존재하는 칼럼만 COMMON으로 식별
common_spec_keys = set(all_spec_keys)
for product_type, keys in spec_keys_by_type.items():
    type_common_keys = set()
    for key in keys:
        frequency = spec_key_frequency[product_type][key]
        if frequency == type_product_count:  # 100% 존재
            type_common_keys.add(key)
    
    # 모든 제품 종류에서 공통인 칼럼만 남김
    common_spec_keys = common_spec_keys.intersection(type_common_keys)
```

#### VARIANT 칼럼 포함/제외 로직

```python
def _should_include_variant_key(...):
    # 1. 등장 빈도 확인
    frequency_ratio = frequency / type_product_count
    
    # 2. 최소 등장 빈도 기준 (50% 이상)
    if frequency_ratio >= 0.5:
        # 3. 온보딩 정보에 따른 중요도 조정
        importance = _calculate_variant_key_importance(...)
        
        # 4. 등장 빈도가 높고 중요도가 높은 경우 포함
        if frequency_ratio >= 0.5 and importance >= 0.8:
            return True
        
        # 5. 등장 빈도가 매우 높은 경우 (80% 이상) 무조건 포함
        if frequency_ratio >= 0.8:
            return True
```

---

### 2. 칼럼 점수 기반 추천 엔진 (`api/services/column_based_recommendation_engine.py`)

#### 추천 프로세스

```
1. 전체 제품 필터링 (예산, 카테고리 등)
   ↓
2. 제품 종류별로 그룹화
   ├─ 세탁기 그룹
   ├─ 청소기 그룹
   ├─ 냉장고 그룹
   └─ ...
   ↓
3. SPEC 구조 분석 (최초 1회)
   ├─ COMMON 칼럼 식별
   └─ VARIANT 칼럼 식별
   ↓
4. 제품 종류별 칼럼 점수 산출
   ├─ 세탁기: 0.85
   ├─ 청소기: 0.78
   ├─ 냉장고: 0.92
   └─ ...
   ↓
5. 칼럼 점수에 따라 패키지에 포함될 가전 종류 선정
   ├─ 최소 점수 기준 (0.3 이상)
   ├─ 칼럼 점수 순 정렬
   ├─ 시나리오별 필수 제품 종류 포함
   └─ 최대 개수 제한 (7개)
   ↓
6. 각 가전 종류별 상위 3개 모델 추천
   ├─ 세탁기: 상위 3개
   ├─ 청소기: 상위 3개
   └─ ...
```

#### 제품 종류 선정 로직

```python
def _select_product_types_for_package(...):
    # 1. 최소 점수 기준 이상인 제품 종류만
    min_score_threshold = 0.3
    qualified_types = [
        product_type
        for product_type, score in column_scores.items()
        if score >= min_score_threshold
    ]
    
    # 2. 칼럼 점수 순으로 정렬
    sorted_types = sorted(qualified_types, key=lambda t: column_scores[t], reverse=True)
    
    # 3. 시나리오별 필수 제품 종류 추가
    scenario_essential_types = get_product_types_for_scenario(...)
    selected_types = set(sorted_types) | set(scenario_essential_types)
    
    # 4. 최대 개수 제한 (7개)
    final_types = list(selected_types)[:7]
    
    return final_types
```

---

## 📊 예시

### 입력

```json
{
  "household_size": 4,
  "housing_type": "apartment",
  "budget_level": "medium",
  "categories": ["TV", "KITCHEN", "LIVING"],
  "onboarding_data": {
    "cooking": "high",
    "laundry": "daily",
    "media": "gaming"
  }
}
```

### 처리 과정

#### Step 1: SPEC 구조 분석

```
COMMON 칼럼: ['가격', '카테고리', '브랜드', ...]
VARIANT 칼럼:
  - 세탁기: ['용량', '세탁모드', '에너지등급', ...]
  - 냉장고: ['용량', '냉장실용량', '냉동실용량', ...]
  - TV: ['해상도', '주사율', '패널타입', ...]
```

#### Step 2: 제품 종류별 칼럼 점수 산출

```
세탁기: 0.85 (COMMON: 0.9, VARIANT: 0.7)
청소기: 0.78 (COMMON: 0.9, VARIANT: 0.6)
냉장고: 0.92 (COMMON: 0.9, VARIANT: 0.95)
TV: 0.88 (COMMON: 0.9, VARIANT: 0.85)
식기세척기: 0.75 (COMMON: 0.9, VARIANT: 0.5)
```

#### Step 3: 제품 종류 선정

```
선정 기준:
- 최소 점수: 0.3 이상
- 정렬: 칼럼 점수 순
- 필수: 시나리오별 필수 제품 종류

선정 결과: [냉장고, TV, 세탁기, 청소기, 식기세척기]
```

#### Step 4: 각 제품 종류별 상위 3개 추천

```
냉장고:
  1. LG 디오스 냉장고 850L (점수: 0.92)
  2. LG 컨버터블 냉장고 750L (점수: 0.89)
  3. LG 일반 냉장고 650L (점수: 0.85)

TV:
  1. LG OLED TV 65형 (점수: 0.90)
  2. LG QNED TV 55형 (점수: 0.87)
  3. LG 나노셀 TV 50형 (점수: 0.82)

... (각 종류별 3개씩)
```

### 출력

```json
{
  "success": true,
  "count": 15,  // 5개 제품 종류 × 3개씩
  "product_types": ["냉장고", "TV", "세탁기", "청소기", "식기세척기"],
  "column_scores": {
    "냉장고": 0.92,
    "TV": 0.88,
    "세탁기": 0.85,
    "청소기": 0.78,
    "식기세척기": 0.75
  },
  "recommendations": [
    {
      "product_type": "냉장고",
      "name": "LG 디오스 냉장고",
      "score": 0.92,
      ...
    },
    // ... 총 15개
  ]
}
```

---

## 🔧 구현 파일

### 1. `api/utils/spec_column_scorer.py`
- SPEC 칼럼 기반 점수 산출 로직
- COMMON/VARIANT 칼럼 분류
- 제품 종류별 칼럼 점수 계산

### 2. `api/services/column_based_recommendation_engine.py`
- 칼럼 점수 기반 추천 엔진
- 제품 종류 선정 로직
- 제품 종류별 상위 3개 모델 추천

---

## ✅ 주요 특징

1. **COMMON 칼럼**: 모든 제품 종류에 공통, 반드시 포함
2. **VARIANT 칼럼**: 등장 빈도와 온보딩 정보에 따라 조건부 포함
3. **동적 제품 종류 선정**: 칼럼 점수에 따라 패키지 포함 가전 종류 결정
4. **제품 종류별 상위 3개**: 각 종류별로 최고 점수 3개 모델 추천
5. **시나리오별 차등화**: 온보딩 정보에 따라 점수 산정 방식 변경

---

## 🚀 사용 방법

```python
from api.services.column_based_recommendation_engine import column_based_recommendation_engine

result = column_based_recommendation_engine.get_recommendations(
    user_profile={
        'household_size': 4,
        'housing_type': 'apartment',
        'budget_level': 'medium',
        'categories': ['TV', 'KITCHEN', 'LIVING']
    },
    onboarding_data={
        'cooking': 'high',
        'laundry': 'daily',
        'media': 'gaming'
    }
)
```

---

## 📝 다음 단계

1. ✅ SPEC 칼럼 점수 산출 로직 구현
2. ✅ 칼럼 점수에 따른 제품 종류 선정 로직 구현
3. ✅ 제품 종류별 상위 3개 모델 추천 로직 구현
4. ⏳ API 엔드포인트 추가
5. ⏳ Oracle DB 실제 구조 확인 및 연동
6. ⏳ 테스트 및 검증


