# 백엔드 로직 분석 및 개선안

## 📋 현재 백엔드 구조

### 1. **데이터베이스 구조**
- **Django ORM (SQLite)**: 메인 데이터베이스
  - `Product`, `ProductSpec`, `ProductReview`, `OnboardingSession`, `Portfolio` 등
- **Oracle 11g (직접 연결)**: 별도 클라이언트 모듈
  - `api/db/oracle_client.py`를 통해 직접 연결
  - Django ORM과 분리되어 있음

### 2. **API 엔드포인트 구조**

#### **기존 Django View (views.py)**
- `POST /api/recommend/` - 추천 API
- `GET /api/products/` - 제품 목록
- `POST /api/onboarding/step/` - 온보딩 단계별 저장
- `POST /api/onboarding/complete/` - 온보딩 완료 및 추천 실행
- `GET /api/onboarding/session/<session_id>/` - 세션 조회
- `POST /api/portfolio/save/` - 포트폴리오 저장
- `GET /api/portfolio/<portfolio_id>/` - 포트폴리오 조회
- AI 관련 엔드포인트들

#### **DRF View (views_drf.py)**
- `POST /api/figma-to-code/` - Figma 이미지 변환

### 3. **추천 엔진 구조**

```
사용자 요청
    ↓
views.py (recommend_view)
    ↓
services/recommendation_engine.py (RecommendationEngine)
    ├─ _validate_user_profile() - 입력 검증
    ├─ _filter_products() - Hard Filtering (카테고리, 가격, 스펙 등)
    ├─ _score_products() - Soft Scoring (가중치 기반 점수 계산)
    │   └─ utils/scoring.py (calculate_product_score)
    │       ├─ 카테고리별 가중치 적용
    │       ├─ Priority별 가중치 조정
    │       └─ Vibe별 디자인 점수
    └─ _format_recommendation() - 최종 포맷팅
        └─ services/recommendation_reason_generator.py (추천 이유 생성)
```

### 4. **주요 서비스 레이어**

1. **RecommendationEngine** (`services/recommendation_engine.py`)
   - 추천 로직의 핵심
   - Hard Filtering + Soft Scoring 방식

2. **Scoring Logic** (`utils/scoring.py`)
   - 제품 점수 계산 (0.0 ~ 1.0)
   - 카테고리별 가중치 적용
   - Priority/Vibe 기반 개인화

3. **Reason Generator** (`services/recommendation_reason_generator.py`)
   - 추천 이유 생성
   - 취향별 템플릿 매칭
   - 리뷰 분석 기반 생성

## 🔍 발견된 문제점

### 1. **데이터베이스 이중 구조**
- SQLite와 Oracle이 분리되어 있음
- Oracle 데이터를 Django ORM으로 사용하지 않음
- 데이터 동기화 문제 가능성

### 2. **추천 로직의 복잡성**
- `rule_engine.py`와 `recommendation_engine.py`가 공존
- `rule_engine.py`는 사용되지 않는 것으로 보임 (deprecated)
- 코드 중복 가능성

### 3. **스코어링 로직의 가중치**
- 카테고리별 가중치가 하드코딩되어 있음
- Priority별 가중치 조정이 복잡함
- 1인 가구에 대한 특별 처리 로직이 여러 곳에 분산

### 4. **에러 처리**
- 일부 함수에서 기본값 반환 (0.5 점수)
- 스펙이 없는 제품에 대한 처리 불명확

### 5. **성능 이슈**
- `_score_products()`에서 최대 50개 제품만 처리
- 리뷰 캐싱은 있지만, 제품 스펙 캐싱 없음

## 💡 개선 제안

### 1. **데이터베이스 통합**
```python
# 옵션 A: Oracle 데이터를 SQLite로 주기적 동기화
# 옵션 B: Oracle을 Django ORM으로 통합 (복잡함)
# 옵션 C: 현재 구조 유지하되, 데이터 동기화 스크립트 추가
```

### 2. **코드 정리**
- `rule_engine.py` 제거 또는 명확한 역할 분리
- 사용되지 않는 함수 정리

### 3. **스코어링 로직 개선**
- 가중치를 설정 파일로 분리 (JSON/YAML)
- Priority별 가중치 조정 로직 단순화
- 1인 가구 처리 로직 통합

### 4. **캐싱 전략**
- 제품 스펙 캐싱 추가
- Redis 또는 메모리 캐싱 도입 검토

### 5. **에러 처리 강화**
- 스펙이 없는 제품에 대한 명확한 처리
- 로깅 강화

### 6. **API 구조 개선**
- DRF로 통일 검토 (현재는 Django View와 DRF 혼재)
- Serializer 검증 강화

## 🎯 우선순위별 개선 작업

### **High Priority**
1. ✅ 코드 정리 (rule_engine.py 정리)
2. ✅ 스코어링 로직 가중치 설정 파일화
3. ✅ 에러 처리 및 로깅 강화

### **Medium Priority**
4. ⚠️ 제품 스펙 캐싱 추가
5. ⚠️ 데이터베이스 동기화 스크립트 작성

### **Low Priority**
6. 📝 DRF로 API 통일
7. 📝 성능 최적화 (쿼리 최적화)

## 📝 다음 단계

1. 사용자와 논의하여 우선순위 결정
2. 개선 작업 시작
3. 테스트 및 검증



