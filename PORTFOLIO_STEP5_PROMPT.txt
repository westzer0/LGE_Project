Step 5: 포트폴리오 조회/관리 API 구현 - 포트폴리오 상세 조회, 목록 조회, 수정, 삭제 API 구현

현재 상황:

- Step 4 완료: 포트폴리오 생성 API 구현 및 통합 완료
- 포트폴리오 데이터 저장 완료: Django DB와 Oracle DB에 포트폴리오 저장됨
- 포트폴리오 조회 필요: 생성된 포트폴리오를 조회하고 관리할 수 있는 API 필요


목표:

포트폴리오 조회 및 관리 API 구현
- 포트폴리오 상세 조회 API (portfolio_id 또는 internal_key로 조회)
- 포트폴리오 목록 조회 API (user_id로 조회)
- 포트폴리오 수정 API (제품 추가/삭제, 스타일 정보 수정)
- 포트폴리오 삭제 API
- Django DB와 Oracle DB 모두에서 조회
- 에러 처리 및 권한 확인


검증 항목:

1. 포트폴리오 상세 조회 API
   - GET /api/portfolio/<portfolio_id>/ 엔드포인트 확인
   - portfolio_id 또는 internal_key로 조회 지원 (LGDX-3)
   - 포트폴리오 기본 정보 조회
   - 제품 목록 조회
   - 스타일 정보 조회
   - 가격 정보 조회
   - 존재하지 않는 포트폴리오 처리

2. 포트폴리오 목록 조회 API
   - GET /api/portfolio/list/?user_id=xxx 엔드포인트 확인
   - user_id로 포트폴리오 목록 조회
   - 정렬 순서 확인 (최신순)
   - 페이지네이션 지원 (선택적)
   - 빈 목록 처리

3. 포트폴리오 수정 API
   - POST /api/portfolio/<portfolio_id>/edit/ 엔드포인트 확인
   - 제품 추가/삭제 기능
   - 스타일 정보 수정 기능
   - 가격 정보 재계산
   - Django DB와 Oracle DB 모두 업데이트

4. 포트폴리오 삭제 API
   - DELETE /api/portfolio/<portfolio_id>/ 엔드포인트 확인
   - Django DB에서 삭제
   - Oracle DB에서 삭제 (CASCADE 또는 수동 삭제)
   - 관련 데이터 삭제 (PORTFOLIO_PRODUCT, PORTFOLIO_SESSION)

5. Django DB와 Oracle DB 조회
   - Django DB에서 조회 (Portfolio 모델)
   - Oracle DB에서 조회 (PORTFOLIO 테이블)
   - 두 DB 모두에서 조회 가능하도록 구현
   - 데이터 일치 확인

6. 에러 처리 및 권한 확인
   - 존재하지 않는 포트폴리오 처리
   - 권한 확인 (user_id 일치 확인)
   - 잘못된 요청 파라미터 처리
   - 사용자에게 적절한 에러 메시지 반환


관련 파일:

- api/views.py
  - portfolio_detail_view() 함수
  - portfolio_list_view() 함수
  - portfolio_edit_view() 함수
  - 포트폴리오 삭제 API (구현 필요)

- api/services/portfolio_service.py
  - get_portfolio() 함수
  - get_portfolio_list() 함수
  - update_portfolio() 함수
  - delete_portfolio() 함수

- api/models.py
  - Portfolio 모델
  - PortfolioProduct 모델
  - PortfolioSession 모델


작업:

1. 포트폴리오 상세 조회 API 확인/개선:
   - portfolio_detail_view() 함수 확인
   - portfolio_id 또는 internal_key로 조회 지원 확인
   - 제품 상세 정보 포함 확인
   - 리뷰 정보 포함 확인 (선택적)
   - 에러 처리 개선

2. 포트폴리오 목록 조회 API 확인/개선:
   - portfolio_list_view() 함수 확인
   - user_id로 조회 확인
   - 정렬 순서 확인 (최신순)
   - 페이지네이션 추가 (선택적)
   - 빈 목록 처리

3. 포트폴리오 수정 API 확인/개선:
   - portfolio_edit_view() 함수 확인
   - 제품 추가/삭제 기능 확인
   - 스타일 정보 수정 기능 확인
   - 가격 정보 재계산 확인
   - Django DB와 Oracle DB 모두 업데이트 확인

4. 포트폴리오 삭제 API 구현:
   - portfolio_delete_view() 함수 작성
   - Django DB에서 삭제
   - Oracle DB에서 삭제
   - 관련 데이터 삭제 (CASCADE 또는 수동)

5. Django DB와 Oracle DB 조회 함수 구현:
   - get_portfolio_from_django() 함수
   - get_portfolio_from_oracle() 함수
   - 두 DB 모두에서 조회 가능하도록 구현

6. 에러 처리 및 권한 확인 추가:
   - 존재하지 않는 포트폴리오 처리
   - 권한 확인 (user_id 일치 확인)
   - 잘못된 요청 파라미터 처리


검증 방법:

1. 포트폴리오 상세 조회 테스트:
   ```python
   def test_portfolio_detail():
       """포트폴리오 상세 조회 테스트"""
       portfolio_id = "PF-TEST01"
       
       # portfolio_id로 조회
       response = client.get(f'/api/portfolio/{portfolio_id}/')
       assert response.status_code == 200
       data = response.json()
       
       assert 'portfolio' in data
       assert data['portfolio']['portfolio_id'] == portfolio_id
       assert 'products' in data['portfolio']
       assert len(data['portfolio']['products']) > 0
       
       print(f"✅ 포트폴리오 상세 조회 성공: {portfolio_id}")
       
       # internal_key로 조회 (LGDX-3)
       internal_key = data['portfolio']['internal_key']
       response2 = client.get(f'/api/portfolio/{internal_key}/')
       assert response2.status_code == 200
       print(f"✅ internal_key로 조회 성공: {internal_key}")
   ```

2. 포트폴리오 목록 조회 테스트:
   ```python
   def test_portfolio_list():
       """포트폴리오 목록 조회 테스트"""
       user_id = "user_123"
       
       response = client.get(f'/api/portfolio/list/?user_id={user_id}')
       assert response.status_code == 200
       data = response.json()
       
       assert 'portfolios' in data
       assert 'count' in data
       assert isinstance(data['portfolios'], list)
       
       print(f"✅ 포트폴리오 목록 조회 성공: {data['count']}개")
       
       # 빈 목록 처리
       response2 = client.get('/api/portfolio/list/?user_id=invalid_user')
       assert response2.status_code == 200
       data2 = response2.json()
       assert data2['count'] == 0
       print("✅ 빈 목록 처리 확인")
   ```

3. 포트폴리오 수정 테스트:
   ```python
   def test_portfolio_edit():
       """포트폴리오 수정 테스트"""
       portfolio_id = "PF-TEST01"
       
       # 제품 추가
       response = client.post(f'/api/portfolio/{portfolio_id}/edit/', {
           'action': 'add_product',
           'product_id': 999
       })
       assert response.status_code == 200
       data = response.json()
       assert data['success'] == True
       
       # 수정 확인
       portfolio = Portfolio.objects.get(portfolio_id=portfolio_id)
       product_ids = [p.get('product_id') for p in portfolio.products]
       assert 999 in product_ids
       print("✅ 제품 추가 성공")
       
       # 제품 삭제
       response2 = client.post(f'/api/portfolio/{portfolio_id}/edit/', {
           'action': 'remove_product',
           'product_id': 999
       })
       assert response2.status_code == 200
       
       # 삭제 확인
       portfolio.refresh_from_db()
       product_ids = [p.get('product_id') for p in portfolio.products]
       assert 999 not in product_ids
       print("✅ 제품 삭제 성공")
   ```

4. 포트폴리오 삭제 테스트:
   ```python
   def test_portfolio_delete():
       """포트폴리오 삭제 테스트"""
       portfolio_id = "PF-TEST01"
       
       # 삭제 전 존재 확인
       portfolio = Portfolio.objects.get(portfolio_id=portfolio_id)
       assert portfolio is not None
       
       # 삭제
       response = client.delete(f'/api/portfolio/{portfolio_id}/')
       assert response.status_code == 200
       data = response.json()
       assert data['success'] == True
       
       # 삭제 확인
       try:
           Portfolio.objects.get(portfolio_id=portfolio_id)
           assert False, "포트폴리오가 삭제되지 않음"
       except Portfolio.DoesNotExist:
           print("✅ 포트폴리오 삭제 성공")
       
       # Oracle DB에서도 삭제 확인
       oracle_portfolio = get_portfolio_from_oracle(portfolio_id)
       assert oracle_portfolio is None
       print("✅ Oracle DB에서도 삭제 확인")
   ```

5. Django DB와 Oracle DB 조회 테스트:
   ```python
   def test_dual_db_retrieval():
       """Django DB와 Oracle DB 조회 테스트"""
       portfolio_id = "PF-TEST01"
       
       # Django DB 조회
       django_portfolio = Portfolio.objects.get(portfolio_id=portfolio_id)
       assert django_portfolio is not None
       
       # Oracle DB 조회
       oracle_portfolio = get_portfolio_from_oracle(portfolio_id)
       assert oracle_portfolio is not None
       
       # 데이터 일치 확인
       assert django_portfolio.portfolio_id == oracle_portfolio['portfolio_id']
       assert len(django_portfolio.products) == len(oracle_portfolio['products'])
       
       print("✅ Django DB와 Oracle DB 조회 확인")
   ```

6. 에러 처리 테스트:
   ```python
   def test_portfolio_errors():
       """포트폴리오 조회 에러 처리 테스트"""
       # 존재하지 않는 포트폴리오
       response = client.get('/api/portfolio/INVALID_ID/')
       assert response.status_code == 404
       print("✅ 존재하지 않는 포트폴리오 에러 처리 확인")
       
       # 잘못된 요청 파라미터
       response2 = client.get('/api/portfolio/list/')
       assert response2.status_code == 400  # user_id 필수
       print("✅ 잘못된 요청 파라미터 에러 처리 확인")
   ```


예상 결과:

1. 포트폴리오 상세 조회:
   - portfolio_id 또는 internal_key로 정상 조회
   - 포트폴리오 기본 정보 정상 조회
   - 제품 목록 정상 조회
   - 존재하지 않는 포트폴리오 적절히 처리

2. 포트폴리오 목록 조회:
   - user_id로 정상 조회
   - 정렬 순서 정상 (최신순)
   - 빈 목록 적절히 처리

3. 포트폴리오 수정:
   - 제품 추가/삭제 정상 작동
   - 스타일 정보 수정 정상 작동
   - 가격 정보 재계산 정상 작동
   - Django DB와 Oracle DB 모두 업데이트

4. 포트폴리오 삭제:
   - Django DB에서 정상 삭제
   - Oracle DB에서 정상 삭제
   - 관련 데이터 정상 삭제

5. Django DB와 Oracle DB 조회:
   - 두 DB 모두에서 정상 조회
   - 데이터 일치 확인

6. 에러 처리:
   - 모든 에러 케이스 적절히 처리
   - 사용자에게 적절한 에러 메시지 반환


테스트 스크립트 구조:

```python
class PortfolioManagementAPIValidator:
    """포트폴리오 조회/관리 API 검증 클래스"""
    
    def validate_all(self):
        """모든 검증 실행"""
        # 1. 포트폴리오 상세 조회
        # 2. 포트폴리오 목록 조회
        # 3. 포트폴리오 수정
        # 4. 포트폴리오 삭제
        # 5. Django DB와 Oracle DB 조회
        # 6. 에러 처리
    
    def _test_portfolio_detail(self):
        """포트폴리오 상세 조회 테스트"""
    
    def _test_portfolio_list(self):
        """포트폴리오 목록 조회 테스트"""
    
    def _test_portfolio_edit(self):
        """포트폴리오 수정 테스트"""
    
    def _test_portfolio_delete(self):
        """포트폴리오 삭제 테스트"""
    
    def _test_dual_db_retrieval(self):
        """Django DB와 Oracle DB 조회 테스트"""
    
    def _test_portfolio_errors(self):
        """포트폴리오 조회 에러 처리 테스트"""
```


시각화 항목:

1. 포트폴리오 조회 플로우 다이어그램
2. API 요청/응답 형식
3. 포트폴리오 조회 성공/실패 비율
4. 조회 시간 분포
5. 에러 유형 분포
6. Django DB vs Oracle DB 조회 성공률


참고:

- portfolio_id와 internal_key 모두로 조회 가능해야 함 (LGDX-3)
- 포트폴리오 수정 시 가격 정보를 재계산해야 함
- 포트폴리오 삭제 시 관련 데이터도 함께 삭제해야 함
- Step 6에서 포트폴리오 공유 기능을 구현할 예정
- Step 7에서 상담 예약 연동 기능을 구현할 예정

