# 필터링 로직 개선 설계

## 📋 목표

온보딩에서 선택한 데이터를 기반으로 **기준에 충족하지 않은 제품들은 구매 항목에서 완전히 제외**하는 엄격한 필터링 로직 구현

---

## 🎯 현재 필터링 로직 (약함)

### 현재 적용되는 필터
1. ✅ 카테고리 필터 (선택한 카테고리만)
2. ✅ 가격 범위 필터 (예산 범위)
3. ✅ 스펙 존재 필터 (스펙이 있는 제품만)
4. ✅ 반려동물 필터 (반려동물 없으면 펫 제품 제외)

### 문제점
- ❌ 가족 인원수에 따른 용량 필터가 약함 (점수만 감점)
- ❌ 주거 형태/평수에 따른 크기 필터 없음
- ❌ 생활 패턴(요리/세탁/미디어) 기반 필터 없음
- ❌ 우선순위 기반 필터 없음 (예: 에너지 효율 우선이면 낮은 등급 제외)

---

## 🔧 개선된 필터링 로직 설계

### 필터링 단계

```
Step 1: 기본 필터 (현재 유지)
  ├─ 카테고리 필터
  ├─ 가격 범위 필터
  ├─ 스펙 존재 필터
  └─ 활성 제품만

Step 2: 가족 구성 기반 필터 (강화) ⭐ NEW
  ├─ 1인 가구: 대용량 제품 완전 제외
  ├─ 2인 가구: 초대형 제품 제외
  └─ 4인 이상: 소형 제품 제외

Step 3: 주거 형태/평수 기반 필터 ⭐ NEW
  ├─ 원룸/오피스텔: 대형 제품 제외
  ├─ 평수 기반: 공간에 맞지 않는 크기 제외
  └─ 주거 형태별 적합 크기 계산

Step 4: 생활 패턴 기반 필터 ⭐ NEW
  ├─ 요리 빈도: 요리 안 하면 일부 주방가전 제외
  ├─ 세탁 빈도: 세탁 안 하면 세탁기 제외
  └─ 미디어 사용: 미디어 안 보면 TV 제외

Step 5: 우선순위 기반 필터 ⭐ NEW
  ├─ 에너지 효율 우선: 3등급 이하 제외
  ├─ 디자인 우선: 기본형 제품 제외 (OBJET/SIGNATURE만)
  └─ 가성비 우선: 프리미엄 제품 제외

Step 6: 반려동물 필터 (현재 유지)
  └─ 반려동물 없으면 펫 제품 제외
```

---

## 📐 필터링 기준 상세

### 1. 가족 구성 기반 용량 필터

#### 1인 가구
```
제외 대상:
- 냉장고: 200L 이상
- 세탁기: 7kg 이상
- TV: 65인치 이상
- 건조기: 10kg 이상
```

#### 2인 가구
```
제외 대상:
- 냉장고: 900L 이상
- 세탁기: 15kg 이상
- TV: 85인치 이상
```

#### 3~4인 가족
```
제외 대상:
- 냉장고: 300L 미만
- 세탁기: 4kg 미만
- TV: 32인치 미만
```

#### 5인 이상 가족
```
제외 대상:
- 냉장고: 400L 미만
- 세탁기: 5kg 미만
- TV: 43인치 미만
```

### 2. 주거 형태/평수 기반 크기 필터

#### 원룸/오피스텔
```
제외 대상:
- 대형 가전 (냉장고 500L 이상, TV 75인치 이상)
- 공간을 많이 차지하는 제품
```

#### 아파트 (평수별)
```
20평 이하:
- 냉장고: 600L 이상 제외
- TV: 75인치 이상 제외

20~30평:
- 냉장고: 900L 이상 제외
- TV: 85인치 이상 제외

30평 이상:
- 제한 없음
```

#### 단독주택
```
제한 없음 (대형 제품 허용)
```

### 3. 생활 패턴 기반 필터

#### 요리 빈도
```
요리 안 함 (rarely):
- 전기레인지 제외
- 식기세척기 제외 (선택적)
- 정수기 제외 (선택적)

가끔 요리 (sometimes):
- 제한 없음

자주 요리 (daily):
- 제한 없음
```

#### 세탁 빈도
```
세탁 안 함 (rarely):
- 세탁기 제외
- 건조기 제외
- 워시타워 제외

가끔 세탁 (weekly):
- 제한 없음

자주 세탁 (daily):
- 제한 없음
```

#### 미디어 사용
```
미디어 안 봄 (rare):
- TV 제외
- 오디오 제품 제외

가끔 봄 (balanced):
- 제한 없음

자주 봄 (frequent):
- 제한 없음
```

### 4. 우선순위 기반 필터

#### 에너지 효율 우선
```
제외 대상:
- 에너지 등급 3등급 이하
- 전력소비량이 매우 높은 제품
```

#### 디자인 우선
```
제외 대상:
- OBJET, SIGNATURE 라인업이 아닌 기본형 제품
  (단, 선택한 카테고리에 OBJET/SIGNATURE가 없으면 예외)
```

#### 가성비 우선
```
제외 대상:
- 프리미엄 라인업 (SIGNATURE 등)
- 가격이 예산 범위 상한선을 크게 초과하는 제품
```

#### 기술/성능 우선
```
제외 대상:
- 구형 모델 (출시일 기준)
- 기본 기능만 있는 제품
```

---

## 💻 구현 계획

### 파일 구조

```
api/services/recommendation_engine.py
  └─ _filter_products() 메서드 개선

api/utils/product_filters.py (신규)
  ├─ filter_by_household_size()      # 가족 구성 필터
  ├─ filter_by_housing_type()        # 주거 형태 필터
  ├─ filter_by_lifestyle()           # 생활 패턴 필터
  └─ filter_by_priority()            # 우선순위 필터
```

### 구현 순서

1. **Step 1**: 가족 구성 기반 필터 구현
2. **Step 2**: 주거 형태/평수 기반 필터 구현
3. **Step 3**: 생활 패턴 기반 필터 구현
4. **Step 4**: 우선순위 기반 필터 구현
5. **Step 5**: 통합 테스트

---

## 📊 필터링 예시

### 시나리오 1: 1인 가구, 원룸, 20평

```
온보딩 데이터:
- 가족 구성: 1인
- 주거 형태: 원룸
- 평수: 20평
- 예산: 500만원 미만
- 카테고리: TV, KITCHEN

필터링 결과:
✅ 포함:
- 냉장고 200L 이하
- TV 55인치 이하
- 소형 세탁기

❌ 제외:
- 냉장고 200L 이상 (대용량)
- TV 65인치 이상 (대형)
- 세탁기 7kg 이상 (대용량)
```

### 시나리오 2: 4인 가족, 아파트, 30평, 에너지 효율 우선

```
온보딩 데이터:
- 가족 구성: 4인
- 주거 형태: 아파트
- 평수: 30평
- 우선순위: 에너지 효율
- 예산: 500~1500만원

필터링 결과:
✅ 포함:
- 에너지 등급 1~2등급 제품
- 중대형 용량 제품

❌ 제외:
- 에너지 등급 3등급 이하
- 소형 제품 (용량 부족)
- 전력소비량 높은 제품
```

### 시나리오 3: 2인 가구, 요리 안 함, 세탁 자주

```
온보딩 데이터:
- 가족 구성: 2인
- 요리 빈도: 거의 안 함
- 세탁 빈도: 자주

필터링 결과:
✅ 포함:
- 세탁기 (자주 사용)
- 건조기 (자주 사용)

❌ 제외:
- 전기레인지 (요리 안 함)
- 식기세척기 (요리 안 함)
```

---

## 🔍 필터링 로직 상세

### 용량 필터 로직

```python
def filter_by_capacity(product, household_size, category):
    """가족 구성에 따른 용량 필터"""
    spec = get_product_spec(product)
    capacity = extract_capacity(spec, category)
    
    if household_size == 1:
        # 1인 가구: 소형만 허용
        if category == 'KITCHEN':
            if capacity > 200:  # 200L 초과 제외
                return False
        elif category == 'LIVING':
            if '세탁기' in product.name and capacity > 7:  # 7kg 초과 제외
                return False
    
    elif household_size >= 4:
        # 4인 이상: 소형 제외
        if category == 'KITCHEN':
            if capacity < 400:  # 400L 미만 제외
                return False
        elif category == 'LIVING':
            if '세탁기' in product.name and capacity < 8:  # 8kg 미만 제외
                return False
    
    return True
```

### 크기 필터 로직

```python
def filter_by_size(product, housing_type, pyung):
    """주거 형태/평수에 따른 크기 필터"""
    spec = get_product_spec(product)
    size = extract_size(spec, product.category)
    
    if housing_type in ['studio', 'officetel']:
        # 원룸/오피스텔: 대형 제품 제외
        if product.category == 'KITCHEN':
            if size > 500:  # 500L 초과 제외
                return False
        elif product.category == 'TV':
            if size > 55:  # 55인치 초과 제외
                return False
    
    elif housing_type == 'apartment':
        # 아파트: 평수에 따라 제한
        if pyung <= 20:
            if product.category == 'KITCHEN' and size > 600:
                return False
            elif product.category == 'TV' and size > 65:
                return False
    
    return True
```

### 생활 패턴 필터 로직

```python
def filter_by_lifestyle(product, user_profile):
    """생활 패턴 기반 필터"""
    category = product.category
    cooking = user_profile.get('cooking', 'sometimes')
    laundry = user_profile.get('laundry', 'weekly')
    media = user_profile.get('media', 'balanced')
    
    # 요리 빈도
    if cooking == 'rarely':
        if '전기레인지' in product.name or '식기세척기' in product.name:
            return False
    
    # 세탁 빈도
    if laundry == 'rarely':
        if '세탁기' in product.name or '건조기' in product.name:
            return False
    
    # 미디어 사용
    if media == 'rare':
        if category == 'TV' or '오디오' in product.name:
            return False
    
    return True
```

### 우선순위 필터 로직

```python
def filter_by_priority(product, user_profile):
    """우선순위 기반 필터"""
    priority = user_profile.get('priority', 'value')
    spec = get_product_spec(product)
    
    if priority == 'eco':
        # 에너지 효율 우선: 3등급 이하 제외
        energy_grade = get_energy_grade(spec)
        if energy_grade and int(energy_grade) > 2:
            return False
    
    elif priority == 'design':
        # 디자인 우선: 기본형 제품 제외
        if 'OBJET' not in product.name and 'SIGNATURE' not in product.name:
            # 단, 선택한 카테고리에 OBJET/SIGNATURE가 없으면 예외
            if not has_objet_or_signature_in_category(product.category):
                return False
    
    elif priority == 'value':
        # 가성비 우선: 프리미엄 제품 제외
        if 'SIGNATURE' in product.name or '프리미엄' in product.name:
            return False
    
    return True
```

---

## ✅ 구현 체크리스트

- [ ] `api/utils/product_filters.py` 파일 생성
- [ ] 가족 구성 기반 용량 필터 구현
- [ ] 주거 형태/평수 기반 크기 필터 구현
- [ ] 생활 패턴 기반 필터 구현
- [ ] 우선순위 기반 필터 구현
- [ ] `recommendation_engine.py`의 `_filter_products()` 메서드 개선
- [ ] 필터링 로직 통합 테스트
- [ ] 필터링 로그 추가 (디버깅용)

---

## 🎯 기대 효과

1. **정확도 향상**: 사용자 조건에 맞지 않는 제품 완전 제외
2. **사용자 만족도 향상**: 불필요한 제품 노출 감소
3. **성능 향상**: 필터링 단계에서 제품 수 감소로 스코어링 부하 감소
4. **명확한 기준**: 필터링 기준이 명확하여 유지보수 용이

