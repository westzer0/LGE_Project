# 필터링 로직 구현 완료

## ✅ 구현 완료 사항

### 1. 새로운 필터링 유틸리티 파일 생성
- **파일**: `api/utils/product_filters.py`
- **기능**: 온보딩 데이터 기반 엄격한 필터링 로직

### 2. 필터링 함수 구현

#### ✅ `filter_by_household_size()` - 가족 구성 기반 용량 필터
- 1인 가구: 대용량 제품 완전 제외 (냉장고 200L 이상, 세탁기 7kg 이상)
- 2인 가구: 초대형 제품 제외 (냉장고 900L 이상, 세탁기 15kg 이상)
- 4인 이상: 소형 제품 제외 (냉장고 300L 미만, 세탁기 4kg 미만)

#### ✅ `filter_by_housing_type()` - 주거 형태/평수 기반 크기 필터
- 원룸/오피스텔: 대형 제품 제외 (냉장고 500L 이상, TV 55인치 이상)
- 아파트 20평 이하: 중대형 제품 제외 (냉장고 600L 이상, TV 65인치 이상)
- 아파트 20~30평: 초대형 제품 제외 (냉장고 900L 이상, TV 85인치 이상)
- 단독주택: 제한 없음

#### ✅ `filter_by_lifestyle()` - 생활 패턴 기반 필터
- 요리 안 함: 전기레인지, 식기세척기 제외
- 세탁 안 함: 세탁기, 건조기, 워시타워 제외
- 미디어 안 봄: TV, 오디오 제품 제외

#### ✅ `filter_by_priority()` - 우선순위 기반 필터
- 에너지 효율 우선: 에너지 등급 3등급 이하 제외
- 디자인 우선: 기본형 제품 제외 (OBJET/SIGNATURE만 허용)
- 가성비 우선: 프리미엄 제품 제외 (SIGNATURE 제외)

#### ✅ `apply_all_filters()` - 통합 필터링 함수
- 모든 필터를 순차적으로 적용
- 필터링 결과 로그 출력

### 3. 추천 엔진 통합
- **파일**: `api/services/recommendation_engine.py`
- `_filter_products()` 메서드 개선
- 기본 필터 (Django ORM) + 추가 필터 (Python 레벨) 2단계 구조

---

## 🔄 필터링 프로세스

```
Step 1: 기본 필터 (Django ORM)
  ├─ 카테고리 필터
  ├─ 가격 범위 필터
  ├─ 스펙 존재 필터
  └─ 반려동물 필터

Step 2: 추가 필터 (Python 레벨) ⭐ NEW
  ├─ 가족 구성 기반 용량 필터
  ├─ 주거 형태/평수 기반 크기 필터
  ├─ 생활 패턴 기반 필터
  └─ 우선순위 기반 필터

결과: 기준에 충족하지 않은 제품 완전 제외
```

---

## 📊 필터링 예시

### 예시 1: 1인 가구, 원룸, 요리 안 함

```
온보딩 데이터:
- 가족 구성: 1인
- 주거 형태: 원룸
- 평수: 20평
- 요리 빈도: 거의 안 함

필터링 결과:
✅ 포함:
- 냉장고 200L 이하
- TV 55인치 이하
- 소형 세탁기

❌ 제외:
- 냉장고 200L 이상 (가족 구성 필터)
- 냉장고 500L 이상 (주거 형태 필터)
- TV 55인치 이상 (주거 형태 필터)
- 전기레인지 (생활 패턴 필터)
- 식기세척기 (생활 패턴 필터)
```

### 예시 2: 4인 가족, 아파트, 에너지 효율 우선

```
온보딩 데이터:
- 가족 구성: 4인
- 주거 형태: 아파트
- 평수: 30평
- 우선순위: 에너지 효율

필터링 결과:
✅ 포함:
- 에너지 등급 1~2등급 제품
- 중대형 용량 제품 (냉장고 300L 이상, 세탁기 4kg 이상)

❌ 제외:
- 냉장고 300L 미만 (가족 구성 필터)
- 세탁기 4kg 미만 (가족 구성 필터)
- 에너지 등급 3등급 이하 (우선순위 필터)
```

---

## 🎯 주요 개선 사항

### Before (기존)
- 필터링이 약함 (점수만 감점)
- 기준에 맞지 않는 제품도 추천 목록에 포함
- 사용자가 불필요한 제품을 봐야 함

### After (개선)
- ✅ 엄격한 필터링 (기준 미충족 제품 완전 제외)
- ✅ 온보딩 데이터를 모두 활용
- ✅ 사용자에게 정확한 제품만 추천
- ✅ 필터링 로그로 디버깅 용이

---

## 📝 사용 방법

### 자동 적용
추천 엔진이 자동으로 필터링을 적용합니다:

```python
# api/services/recommendation_engine.py
result = recommendation_engine.get_recommendations(user_profile)
# → 내부적으로 _filter_products() 호출
# → apply_all_filters() 자동 적용
```

### 수동 사용
필터링 유틸리티를 직접 사용할 수도 있습니다:

```python
from api.utils.product_filters import apply_all_filters

products = Product.objects.filter(is_active=True)
filtered = apply_all_filters(products, user_profile)
```

---

## 🔍 디버깅

필터링 과정이 로그로 출력됩니다:

```
[Filter Step 1] 기본 필터: 카테고리=['TV', 'KITCHEN'], 가격=500000~2000000원, 가족=1명, 반려동물=False, 결과=150개
[필터링 결과]
  원본: 150개
  필터링 후: 45개
  제외된 제품:
    - 가족 구성: 60개
    - 주거 형태: 25개
    - 생활 패턴: 15개
    - 우선순위: 5개
[Filter Step 2] 추가 필터링 후: 45개
```

---

## ✅ 테스트 체크리스트

- [x] 가족 구성 필터 테스트
- [x] 주거 형태 필터 테스트
- [x] 생활 패턴 필터 테스트
- [x] 우선순위 필터 테스트
- [x] 통합 필터링 테스트
- [ ] 실제 추천 API 테스트
- [ ] 성능 테스트

---

## 🚀 다음 단계

1. **실제 데이터로 테스트**: 다양한 온보딩 조합으로 테스트
2. **성능 최적화**: 필터링 로직 최적화 (필요시)
3. **필터 기준 조정**: 실제 사용 데이터를 바탕으로 기준 조정
4. **에러 처리 강화**: 스펙 정보가 없는 제품 처리 개선

---

## 📚 관련 파일

- `api/utils/product_filters.py`: 필터링 유틸리티
- `api/services/recommendation_engine.py`: 추천 엔진 (필터링 통합)
- `필터링_로직_개선_설계.md`: 설계 문서

