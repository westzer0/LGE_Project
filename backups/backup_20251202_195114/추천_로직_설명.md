# 추천 로직 상세 설명

## 🎯 사용자 이해 확인

사용자가 이해한 로직:
1. 제품에 인구통계학적 정보, 가격정보 등 정량적인 데이터로 sorting 후
2. 온보딩이 완료된 사용자 별로 제품 칼럼에 스코어링이 다르게 배정
3. 스코어링이 완료된 제품 중 높은 점수가 해당 온보딩의 사용자에게 제일 적합하다고 판단하여 추천

## ✅ 실제 로직 구조

### 1단계: Hard Filtering (필터링)
**"sorting 후"가 아니라 "필터링 후"가 정확합니다!**

```python
# api/services/recommendation_engine.py
def _filter_products(self, user_profile: dict):
    """
    조건에 맞는 제품만 필터링
    - 카테고리 필터
    - 가격 범위 필터
    - 스펙 존재 필터
    """
    products = Product.objects.filter(
        is_active=True,
        category__in=categories,           # 선택한 카테고리만
        price__gte=min_price,              # 최소 가격 이상
        price__lte=max_price,              # 최대 가격 이하
        price__gt=0,                       # 가격 0 제외
        spec__isnull=False                 # 스펙이 있는 제품만
    )
    return products  # 조건에 맞는 제품들만 반환
```

**이 단계에서는:**
- ❌ 정량적 데이터로 "sorting" (정렬) ❌
- ✅ 정량적 데이터로 "filtering" (필터링) ✅

예를 들어:
- 카테고리가 "TV"인 제품만
- 가격이 50만원~200만원 범위인 제품만
- 스펙 정보가 있는 제품만

### 2단계: Soft Scoring (스코어링)
**사용자의 이해가 정확합니다! ✅**

```python
# api/services/recommendation_engine.py
def _score_products(self, products, user_profile):
    """
    필터링된 제품들에 대해 사용자별 점수 계산
    """
    scored = []
    for product in products:
        # 각 제품마다 사용자 프로필에 맞는 점수 계산
        score = calculate_product_score(product, profile)
        scored.append({
            'product': product,
            'score': score  # 사용자별로 다른 점수!
        })
    return scored
```

**이 단계에서는:**
- ✅ 온보딩 완료된 사용자별로
- ✅ 각 제품에 대해 스코어링이 **다르게** 배정됨

예를 들어:
- 1인 가구 사용자 → 작은 용량 제품에 높은 점수
- 4인 가구 사용자 → 큰 용량 제품에 높은 점수
- 반려동물 있는 사용자 → 펫 관련 기능 제품에 높은 점수

### 3단계: 정렬 및 상위 선택
**사용자의 이해가 정확합니다! ✅**

```python
# api/services/recommendation_engine.py
# 4. 정렬 및 상위 K개 선택
top_products = sorted(
    scored_products,
    key=lambda x: x['score'],  # 점수 기준으로 정렬
    reverse=True               # 높은 순서대로
)[:limit]  # 상위 3개만 선택
```

**이 단계에서는:**
- ✅ 스코어링이 완료된 제품들을 점수 순으로 정렬
- ✅ 높은 점수 = 해당 사용자에게 가장 적합한 제품

## 📊 전체 흐름 다이어그램

```
[전체 제품 데이터베이스]
         ↓
    [Hard Filtering]
    - 카테고리 필터
    - 가격 범위 필터
    - 스펙 존재 필터
         ↓
[필터링된 제품들]
    예: TV 카테고리, 50만~200만원, 100개
         ↓
    [Soft Scoring]
    사용자 A (1인 가구, 반려동물 없음)
    → 제품 1: 0.75점
    → 제품 2: 0.85점
    → 제품 3: 0.65점
    ...
         ↓
    [정렬 및 선택]
    점수 순: 0.85 > 0.75 > 0.65 ...
         ↓
    [최종 추천]
    상위 3개 제품 반환
```

## 🔍 실제 코드 흐름

### Step 1: Hard Filtering
```python
# recommendation_engine.py:91
filtered_products = self._filter_products(user_profile)

# 필터링 기준:
# - 카테고리: ['TV'] → TV 제품만
# - 가격: 50만원 ~ 200만원
# - 스펙 존재 여부
# - 활성화된 제품만

# 결과: 100개 제품 → 50개 제품으로 축소
```

### Step 2: Soft Scoring
```python
# recommendation_engine.py:101
scored_products = self._score_products(filtered_products, user_profile)

# 각 제품마다 점수 계산:
# - 해상도 점수 (0.0 ~ 1.0)
# - 가격 적합도 점수 (0.0 ~ 1.0)
# - 가족 인원 점수 (0.0 ~ 1.0)
# - 반려동물 점수 (0.0 ~ 1.0)
# - 디자인 점수 (0.0 ~ 1.0)
# → 가중치 합산하여 최종 점수

# 결과: 각 제품마다 0.0 ~ 1.0 사이의 점수 부여
```

### Step 3: 정렬 및 선택
```python
# recommendation_engine.py:107
top_products = sorted(
    scored_products,
    key=lambda x: x['score'],
    reverse=True
)[:limit]

# 점수 높은 순서대로 정렬:
# - 제품 A: 0.85점
# - 제품 B: 0.80점
# - 제품 C: 0.75점
# ...
# → 상위 3개 선택
```

## 💡 스코어링 상세 설명

### 점수 계산 방법

```python
# api/utils/scoring.py
def calculate_product_score(product, profile):
    """
    각 제품의 종합 점수 계산
    """
    # 1. 개별 스펙 점수 계산
    resolution_score = score_resolution(spec, profile)      # 해상도
    price_score = score_price_match(product, profile)        # 가격 적합도
    household_score = score_household_size(...)              # 가족 인원
    pet_score = score_pet_friendliness(...)                  # 반려동물
    
    # 2. 가중치 적용
    total_score = (
        resolution_score * 0.25 +    # 25% 가중치
        price_score * 0.15 +         # 15% 가중치
        household_score * 0.30 +     # 30% 가중치
        pet_score * 0.30             # 30% 가중치
    )
    
    # 3. 보너스/페널티 추가
    if household_size == 1:
        if '소형' in product_name:
            total_score += 0.15  # 보너스
        elif '대용량' in product_name:
            total_score -= 0.20  # 페널티
    
    return total_score  # 0.0 ~ 1.0
```

### 사용자별 다른 점수 예시

**사용자 A (1인 가구, 반려동물 없음):**
- 소형 냉장고 (300L): 0.85점 ✅
- 대형 냉장고 (900L): 0.50점

**사용자 B (4인 가구, 반려동물 있음):**
- 소형 냉장고 (300L): 0.45점
- 대형 냉장고 (900L): 0.90점 ✅
- 펫 털 제거 청소기: 0.95점 ✅

## ✅ 정확한 로직 요약

### 실제 로직
1. ✅ **Hard Filtering**: 조건에 맞는 제품만 필터링 (sorting 아님!)
2. ✅ **Soft Scoring**: 사용자별로 각 제품에 다른 점수 부여
3. ✅ **정렬 및 선택**: 높은 점수 순으로 정렬 후 상위 선택

### 사용자 이해 수정
- ❌ "정량적 데이터로 sorting 후"
- ✅ "정량적 데이터로 filtering 후"

나머지는 정확합니다! ✅

