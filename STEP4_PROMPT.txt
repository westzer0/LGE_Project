Step 4: MEMBER 테이블 저장 로직 검증 - TasteCalculationService가 MEMBER.TASTE에 올바르게 저장하는지 테스트



현재 상황:

- Step 1 완료: 모든 필수 인프라 준비됨 (테이블, 컬럼, 제약조건 확인 완료)
- Step 2 완료: 온보딩 데이터 조회 로직 검증 완료 (_get_onboarding_data_from_session() 정상 작동 확인)
- Step 3 완료: Taste 계산 로직 검증 완료 (TasteClassifier가 올바른 Taste ID 반환 확인)
- 실제 DB에 ONBOARDING_SESSION 레코드 1,056개 존재
- 정규화 테이블 (ONBOARD_SESS_MAIN_SPACES, ONBOARD_SESS_PRIORITIES) 데이터 저장 완료



목표:

TasteCalculationService.calculate_and_save_taste() 메서드가 올바르게 작동하는지 검증



검증 항목:

1. MEMBER 테이블 저장 성공
   - MEMBER 테이블에 TASTE 값이 올바르게 저장되는지 확인
   - UPDATE 쿼리가 정상 실행되는지 확인
   - 저장 전후 TASTE 값 비교

2. TASTE 값 범위 검증
   - 저장된 TASTE 값이 1~120 범위 내인지 확인
   - 범위를 벗어난 값이 자동으로 보정되는지 확인 (1 미만 → 1, 120 초과 → 120)

3. 전체 플로우 검증
   - 온보딩 세션 데이터 조회 → Taste 계산 → MEMBER 테이블 저장 전체 플로우 테스트
   - Step 2와 Step 3의 결과를 활용하여 실제 데이터로 검증

4. MEMBER_ID 검증
   - 존재하는 MEMBER_ID로 저장 성공 확인
   - 존재하지 않는 MEMBER_ID 처리 확인
   - NULL MEMBER_ID 처리 확인

5. 데이터 일관성 검증
   - 동일한 온보딩 데이터로 여러 번 계산 시 동일한 TASTE 값이 저장되는지 확인
   - 저장 후 조회(get_taste_for_member) 시 올바른 값이 반환되는지 확인

6. 트랜잭션 검증
   - 저장 실패 시 롤백되는지 확인
   - 여러 MEMBER에 동시 저장 시 데이터 무결성 확인

7. NULL 값 처리
   - TASTE가 NULL인 MEMBER에 저장하는 경우
   - 저장 후 NULL이 아닌 값으로 변경되는지 확인



관련 파일:

- api/services/taste_calculation_service.py (라인 12~55)
  - calculate_and_save_taste() 메서드
  - get_taste_for_member() 메서드 (라인 140~165)
  - _get_onboarding_data_from_session() 메서드 (Step 2에서 검증 완료)

- api/utils/taste_classifier.py (Step 3에서 검증 완료)
  - calculate_taste_from_onboarding() 메서드

- api/db/oracle_client.py
  - get_connection() 함수

- api/db/member_taste_alter.sql
  - MEMBER.TASTE 컬럼 구조 및 제약조건 정의



작업:

1. test_taste_member_storage.py 테스트 스크립트 작성

2. 테스트 케이스 작성:
   - 기본 케이스: 실제 SESSION_ID와 MEMBER_ID로 전체 플로우 테스트
   - 범위 검증: 계산된 TASTE가 1~120 범위인지 확인
   - 저장 검증: MEMBER 테이블에 올바르게 저장되는지 확인
   - 조회 검증: 저장 후 get_taste_for_member()로 조회하여 일치하는지 확인

3. 실제 세션 데이터로 검증:
   - Step 2에서 사용한 실제 SESSION_ID 20개로 테스트
   - 각 세션의 MEMBER_ID를 찾아서 TASTE 저장 테스트
   - 저장 전후 TASTE 값 비교

4. MEMBER_ID 검증:
   - 존재하는 MEMBER_ID로 저장 테스트
   - 존재하지 않는 MEMBER_ID 처리 확인
   - GUEST MEMBER_ID로 저장 테스트

5. 데이터 일관성 테스트:
   - 동일한 온보딩 데이터로 여러 번 계산하여 동일한 TASTE 값 확인
   - 저장 후 조회하여 일치하는지 확인

6. 시각화 생성:
   - 저장된 TASTE 값 분포 히스토그램
   - 저장 성공/실패 비율
   - TASTE 값 범위 분포



예상 저장 형식:

MEMBER 테이블:
- MEMBER_ID: VARCHAR2(30) (PRIMARY KEY)
- TASTE: NUMBER(3) (1~120 범위, NULL 가능)

저장 쿼리:
```sql
UPDATE MEMBER
SET TASTE = :taste_id
WHERE MEMBER_ID = :member_id
```

예시:
- 입력: member_id='GUEST', onboarding_session_id='1764840383702'
- 처리: 온보딩 데이터 조회 → Taste 계산 (예: 45) → MEMBER 테이블 저장
- 결과: MEMBER 테이블의 GUEST 레코드에 TASTE = 45 저장



검증 방법:

1. 단위 테스트:
   - calculate_and_save_taste() 메서드를 직접 호출하여 테스트
   - 저장 전후 MEMBER 테이블의 TASTE 값 비교
   - 반환값이 올바른지 확인

2. 통합 테스트:
   - 실제 SESSION_ID와 MEMBER_ID로 전체 플로우 테스트
   - Step 2 → Step 3 → Step 4 연계 테스트

3. 일관성 테스트:
   - 동일한 입력으로 여러 번 저장하여 동일한 결과 확인
   - 저장 후 조회하여 일치하는지 확인

4. 범위 테스트:
   - 다양한 온보딩 데이터로 계산된 TASTE 값이 모두 1~120 범위인지 확인
   - 범위를 벗어난 값이 자동 보정되는지 확인

5. 에러 처리 테스트:
   - 존재하지 않는 MEMBER_ID로 저장 시도
   - 존재하지 않는 SESSION_ID로 저장 시도
   - NULL 값 처리 확인

6. 시각화:
   - 저장된 TASTE 값 분포 히스토그램 (1~120 범위)
   - 저장 성공/실패 비율
   - TASTE 값별 저장 횟수 분포



참고:

- MEMBER.TASTE는 NUMBER(3) 타입 (1~120 범위)
- 제약조건: CHECK (TASTE IS NULL OR (TASTE >= 1 AND TASTE <= 120))
- calculate_and_save_taste()는 범위 검증을 애플리케이션 레벨에서 수행 (1 미만 → 1, 120 초과 → 120)
- Step 2에서 검증한 실제 SESSION_ID 샘플 활용 가능
- Step 3에서 검증한 TasteClassifier 결과 활용 가능
- test_taste_data_retrieval.py와 test_taste_calculation.py의 구조를 참고하여 작성

