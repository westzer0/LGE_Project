# Oracle 연결 단계별 테스트 가이드

## 🔍 문제 진단

현재 발생하는 오류들(`DPY-3001`, `DPY-6003`)은 모두 **연결(Connection) 생성 시점**에서 발생하는 오류입니다.

**중요**: `conn = oracledb.connect(...)` 단계에서 막히고 있으므로, 커서(cursor) 생성 전에 문제가 발생하는 것입니다.

---

## ✅ 단계별 테스트 절차

### 1단계: 환경 변수 확인

`.env` 파일이 프로젝트 루트에 있고, 다음 5개 값이 모두 정확히 설정되어 있는지 확인:

```env
ORACLE_USER=campus_24K_LG3_DX7_p3_4
ORACLE_PASSWORD=smhrd4
ORACLE_HOST=project-db-campus.smhrd.com
ORACLE_PORT=1524
ORACLE_SERVICE_NAME=MAPPP
```

**확인 방법**:
```powershell
# 환경 변수가 제대로 읽히는지 확인
python -c "import os; from dotenv import load_dotenv; load_dotenv(); print('USER:', os.getenv('ORACLE_USER')); print('HOST:', os.getenv('ORACLE_HOST')); print('SERVICE_NAME:', os.getenv('ORACLE_SERVICE_NAME'))"
```

---

### 2단계: 연결(Connection) 테스트

**목적**: `oracledb.connect()` 단계가 성공하는지 확인

```powershell
python test_oracle.py
```

**예상 출력 (성공 시)**:
```
============================================================
Oracle 데이터베이스 연결 확인 (Thin 모드)
============================================================

연결 설정:
  USER: campus_24K_LG3_DX7_p3_4
  DSN:  project-db-campus.smhrd.com:1524/MAPPP
  ...

============================================================
1단계: 연결(Connection) 생성 시도
============================================================
연결 테스트 중...
✅ 연결(Connection) 성공!
   → conn = oracledb.connect() 단계를 통과했습니다.

============================================================
2단계: 커서(Cursor) 및 쿼리 테스트
============================================================
✅ 간단 쿼리 성공: 현재 계정 = CAMPUS_24K_LG3_DX7_P3_4

============================================================
✅ 전체 테스트 성공!
============================================================
```

**실패 시 확인 사항**:
- ❌ 연결 실패: `.env` 파일의 값이 올바른지 확인
- ❌ DPY-3001 오류: Bequeath 모드 오류 → DSN이 명시적으로 지정되어 있는지 확인
- ❌ DPY-6003 오류: Service Name이 올바른지 확인

---

### 3단계: 커서(Cursor) 최소 테스트

연결이 성공한 후, 가장 간단한 쿼리로 커서가 정상 동작하는지 확인:

```python
with conn.cursor() as cur:
    cur.execute("SELECT user FROM dual")
    print(cur.fetchone())  # 현재 계정 이름이 출력되면 정상
```

**성공 기준**: 현재 계정 이름이 한 줄이라도 출력되면, 연결 + 커서 + 쿼리가 모두 정상입니다.

---

### 4단계: Django 연결 테스트

`test_oracle.py`가 성공했다면, 동일한 DSN과 계정 정보를 Django 설정에도 적용:

```powershell
python check_connection.py
```

---

## 🔧 문제 해결 체크리스트

### 연결 단계에서 실패하는 경우

- [ ] `.env` 파일이 프로젝트 루트에 있는가?
- [ ] `.env` 파일의 `ORACLE_USER`, `ORACLE_PASSWORD` 등이 모두 채워져 있는가?
- [ ] 키 이름이 정확한가? (`ORACLE_USER` vs `DB_USER`)
- [ ] `test_oracle.py`에서 DSN이 올바르게 생성되는가?
- [ ] `oracledb.init_oracle_client()`를 호출하지 않는가?

### 커서 단계에서 실패하는 경우

연결은 성공했지만 커서/쿼리에서 실패하면:

- [ ] 쿼리 내용(테이블명, 스키마)이 올바른가?
- [ ] 해당 계정에 쿼리 실행 권한이 있는가?
- [ ] 테이블이나 뷰가 실제로 존재하는가?

---

## 📝 핵심 정리

1. **연결 단계**: `conn = oracledb.connect(...)` 가 성공해야 함
   - 이 단계에서 DPY-3001, DPY-6003 오류 발생
   - 커서 생성 전에 실패

2. **커서 단계**: 연결이 성공한 후에만 테스트 가능
   - `SELECT user FROM dual` 같은 간단한 쿼리로 먼저 확인
   - 성공하면 연결 + 커서가 모두 정상

3. **문제의 핵심**: 현재까지의 증상만 보면 문제는 연결 설정/환경(Django, NAME/HOST/PORT 처리) 쪽에 있음

---

## 🎯 권장 순서

1. ✅ `.env` 파일의 `ORACLE_*` 값 확인
2. ✅ `test_oracle.py`로 연결 + 간단 쿼리(`SELECT user FROM dual`) 테스트
3. ✅ 성공하면, 같은 DSN과 계정 정보를 `check_connection.py`나 Django 설정에도 그대로 복사

---

## 💡 추가 팁

- `test_oracle.py`는 Django 없이 순수 `oracledb`만 사용하므로, Django 설정 문제와 분리하여 테스트 가능
- 연결이 성공하면 나머지는 쿼리 문제일 가능성이 높음
- 연결이 실패하면 환경 변수나 네트워크 문제일 가능성이 높음



