Step 5: 통합 테스트 - 온보딩 완료 시점에서 전체 플로우 테스트 (조건 체크 → 데이터 조회 → 계산 → 저장)



현재 상황:

- Step 1 완료: 모든 필수 인프라 준비됨 (테이블, 컬럼, 제약조건 확인 완료)
- Step 2 완료: 온보딩 데이터 조회 로직 검증 완료 (_get_onboarding_data_from_session() 정상 작동 확인)
- Step 3 완료: Taste 계산 로직 검증 완료 (TasteClassifier가 올바른 Taste ID 반환 확인)
- Step 4 완료: MEMBER 테이블 저장 로직 검증 완료 (calculate_and_save_taste() 정상 작동 확인)
- 실제 DB에 ONBOARDING_SESSION 레코드 1,056개 이상 존재
- 정규화 테이블 (ONBOARD_SESS_MAIN_SPACES, ONBOARD_SESS_PRIORITIES) 데이터 저장 완료



목표:

온보딩 완료 시점에서 전체 플로우가 올바르게 작동하는지 통합 테스트
- 조건 체크 (STATUS='COMPLETED' && MEMBER_ID != 'GUEST')
- 온보딩 데이터 조회
- Taste 계산
- MEMBER 테이블 저장



검증 항목:

1. 온보딩 완료 조건 검증
   - STATUS='COMPLETED'인 세션만 Taste 계산이 실행되는지 확인
   - MEMBER_ID가 'GUEST'인 경우 Taste 계산이 건너뛰어지는지 확인
   - STATUS != 'COMPLETED'인 경우 Taste 계산이 실행되지 않는지 확인

2. 전체 플로우 통합 검증
   - 온보딩 완료 조건 확인 → 데이터 조회 → Taste 계산 → MEMBER 테이블 저장 전체 플로우 테스트
   - 실제 완료된 세션(STATUS='COMPLETED')으로 전체 플로우 검증
   - 각 단계별 성공/실패 여부 확인

3. 실제 완료 세션 데이터로 검증
   - STATUS='COMPLETED'인 실제 세션 100개 이상으로 테스트
   - MEMBER_ID가 'GUEST'가 아닌 세션만 선택하여 테스트
   - 각 세션의 MEMBER_ID에 TASTE 값이 올바르게 저장되는지 확인

4. 조건별 분기 검증
   - STATUS='COMPLETED' && MEMBER_ID != 'GUEST': Taste 계산 및 저장 실행
   - STATUS='COMPLETED' && MEMBER_ID == 'GUEST': Taste 계산 건너뜀
   - STATUS != 'COMPLETED': Taste 계산 실행 안 함

5. 에러 처리 검증
   - 온보딩 데이터 조회 실패 시 처리
   - Taste 계산 실패 시 처리
   - MEMBER 테이블 저장 실패 시 처리
   - 각 단계에서 실패해도 다른 단계에 영향을 주지 않는지 확인

6. 데이터 일관성 검증
   - 동일한 완료 세션으로 여러 번 실행 시 동일한 TASTE 값이 저장되는지 확인
   - 저장 후 조회(get_taste_for_member) 시 올바른 값이 반환되는지 확인

7. 성능 검증
   - 100개 이상의 완료 세션을 처리하는 시간 측정
   - 각 단계별 소요 시간 측정



관련 파일:

- api/services/onboarding_db_service.py (라인 1112~1149)
  - create_or_update_session() 메서드 내 Taste 계산 로직
  - 조건: status == 'COMPLETED' and final_member_id and final_member_id != 'GUEST'
  - taste_calculation_service.calculate_and_save_taste() 호출

- api/services/taste_calculation_service.py
  - calculate_and_save_taste() 메서드 (Step 4에서 검증 완료)
  - _get_onboarding_data_from_session() 메서드 (Step 2에서 검증 완료)
  - get_taste_for_member() 메서드

- api/utils/taste_classifier.py (Step 3에서 검증 완료)
  - calculate_taste_from_onboarding() 메서드

- api/db/oracle_client.py
  - get_connection() 함수

- api/views.py (라인 1375~)
  - onboarding_complete_view() 함수
  - 온보딩 완료 API 엔드포인트



작업:

1. test_taste_integration.py 테스트 스크립트 작성

2. 테스트 케이스 작성:
   - 완료 조건 검증: STATUS='COMPLETED'인 세션 찾기
   - 전체 플로우 테스트: 조건 체크 → 데이터 조회 → 계산 → 저장
   - 조건별 분기 테스트: 각 조건에 따른 분기 동작 확인
   - 에러 처리 테스트: 각 단계별 에러 처리 확인

3. 실제 완료 세션 데이터로 검증:
   - STATUS='COMPLETED' && MEMBER_ID != 'GUEST'인 세션 100개 이상 무작위 추출
   - 각 세션에 대해 전체 플로우 실행
   - 저장 전후 TASTE 값 비교
   - 저장 후 조회하여 일치하는지 확인

4. 조건별 분기 테스트:
   - STATUS='COMPLETED' && MEMBER_ID != 'GUEST': 정상 실행 확인
   - STATUS='COMPLETED' && MEMBER_ID == 'GUEST': 건너뛰기 확인
   - STATUS='IN_PROGRESS': 실행 안 함 확인
   - STATUS='ABANDONED': 실행 안 함 확인

5. 에러 처리 테스트:
   - 존재하지 않는 SESSION_ID로 테스트
   - 데이터가 불완전한 세션으로 테스트
   - MEMBER 테이블에 없는 MEMBER_ID로 테스트

6. 성능 측정:
   - 100개 세션 처리 시간 측정
   - 각 단계별 평균 처리 시간 계산

7. 시각화 생성:
   - 전체 플로우 성공/실패 비율
   - 조건별 분기 실행 횟수
   - TASTE 값 분포 히스토그램
   - 단계별 처리 시간 분포
   - 에러 발생 빈도



예상 플로우:

```
1. 조건 체크:
   - STATUS = 'COMPLETED' 확인
   - MEMBER_ID != 'GUEST' 확인
   
2. 데이터 조회:
   - _get_onboarding_data_from_session(session_id) 호출
   - 온보딩 데이터 딕셔너리 반환
   
3. Taste 계산:
   - taste_classifier.calculate_taste_from_onboarding(onboarding_data) 호출
   - Taste ID (1~120) 반환
   
4. MEMBER 테이블 저장:
   - UPDATE MEMBER SET TASTE = :taste_id WHERE MEMBER_ID = :member_id
   - 저장 성공 확인
   
5. 검증:
   - get_taste_for_member(member_id)로 조회하여 저장된 값 확인
```

예시:
- 입력: SESSION_ID='1764840383702', STATUS='COMPLETED', MEMBER_ID='user_750'
- 처리:
  1. 조건 체크: STATUS='COMPLETED' ✅, MEMBER_ID != 'GUEST' ✅
  2. 데이터 조회: 온보딩 데이터 딕셔너리 반환
  3. Taste 계산: Taste ID = 52 계산
  4. 저장: MEMBER 테이블의 user_750 레코드에 TASTE = 52 저장
  5. 검증: get_taste_for_member('user_750') = 52 ✅



검증 방법:

1. 통합 테스트:
   - 실제 완료된 세션(STATUS='COMPLETED')으로 전체 플로우 테스트
   - 각 단계별 성공/실패 여부 확인
   - 최종적으로 MEMBER 테이블에 올바른 TASTE 값이 저장되었는지 확인

2. 조건 검증:
   - STATUS='COMPLETED'인 세션만 선택하여 테스트
   - MEMBER_ID='GUEST'인 세션은 건너뛰는지 확인
   - STATUS != 'COMPLETED'인 세션은 실행하지 않는지 확인

3. 분기 테스트:
   - 각 조건 조합에 대해 올바른 분기가 실행되는지 확인
   - 조건에 맞지 않는 경우 Taste 계산이 실행되지 않는지 확인

4. 에러 처리 테스트:
   - 각 단계에서 에러가 발생해도 다른 단계에 영향을 주지 않는지 확인
   - 에러 발생 시 적절한 로깅이 되는지 확인

5. 일관성 테스트:
   - 동일한 완료 세션으로 여러 번 실행하여 동일한 결과 확인
   - 저장 후 조회하여 일치하는지 확인

6. 성능 테스트:
   - 100개 이상의 완료 세션을 처리하는 시간 측정
   - 각 단계별 평균 처리 시간 계산
   - 병목 구간 식별

7. 시각화:
   - 전체 플로우 성공/실패 비율 파이 차트
   - 조건별 분기 실행 횟수 바 차트
   - TASTE 값 분포 히스토그램 (1~120)
   - 단계별 처리 시간 박스 플롯
   - 에러 발생 빈도 바 차트



참고:

- 온보딩 완료 조건: STATUS='COMPLETED' AND MEMBER_ID != 'GUEST'
- 온보딩 상태 값: 'IN_PROGRESS', 'COMPLETED', 'ABANDONED'
- Step 1~4에서 검증한 모든 로직이 통합되어 작동하는지 확인
- 실제 운영 환경과 동일한 조건으로 테스트
- test_taste_member_storage.py의 구조를 참고하여 작성
- 무작위 추출로 100개 이상의 완료 세션으로 테스트하여 통계적 신뢰성 확보



테스트 스크립트 구조:

```python
class TasteIntegrationValidator:
    """온보딩 완료 시점 전체 플로우 통합 검증 클래스"""
    
    def validate_all(self):
        """모든 검증 실행"""
        # 1. 완료 조건 검증
        # 2. 전체 플로우 통합 검증
        # 3. 실제 완료 세션 데이터로 검증 (100개 이상)
        # 4. 조건별 분기 검증
        # 5. 에러 처리 검증
        # 6. 성능 측정
        # 7. 시각화 생성
    
    def _get_completed_sessions(self, count=100):
        """STATUS='COMPLETED' && MEMBER_ID != 'GUEST'인 세션 무작위 추출"""
    
    def _validate_completion_conditions(self):
        """온보딩 완료 조건 검증"""
    
    def _validate_full_flow(self):
        """전체 플로우 통합 검증"""
    
    def _validate_conditional_branches(self):
        """조건별 분기 검증"""
    
    def _validate_error_handling(self):
        """에러 처리 검증"""
    
    def _measure_performance(self):
        """성능 측정"""
```

